{% extends "base.html" %}
{% load report_extras %}

{% block title %}Hisobot №1 - Yaratish{% endblock %}

{% block content %}
<style>
  .t1-card{
    border: 1px solid var(--stroke);
    border-radius: 20px;
    box-shadow: var(--shadow);
    padding: 14px;
    backdrop-filter: blur(14px);
  }

  .t1-title{
    margin:0 0 6px 0;
    font-size: 18px;
    font-weight: 950;
    color: var(--text);
    letter-spacing: -.01em;
  }

  .t1-muted{ color: var(--muted); font-size: 13px; line-height: 1.45; margin: 0; }

  .t1-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
    margin: 12px 0 12px;
  }

  .t1-field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 220px;
    max-width: 260px;
  }
  .t1-field label{
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }

  .t1-inp{
    height: 44px;
    border-radius: 14px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.55);
    color: var(--text);
    padding: 0 12px;
    outline: none;
    box-shadow: 0 14px 34px rgba(15,23,42,.08);
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  }
  html[data-theme="dark"] .t1-inp{ background: rgba(255,255,255,.06); box-shadow: 0 18px 70px rgba(0,0,0,.28); }
  .t1-inp:focus{
    border-color: rgba(99,102,241,.45);
    box-shadow: var(--ring);
    background: rgba(255,255,255,.70);
  }
  html[data-theme="dark"] .t1-inp:focus{ background: rgba(255,255,255,.09); }

  .t1-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    height: 44px;
    padding: 0 14px;
    border-radius: 14px;
    border: 1px solid var(--stroke);
    text-decoration:none;
    font-weight: 950;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, background .12s ease;
    user-select:none;
    white-space: nowrap;
  }
  .t1-btn.primary{
    color:#fff;
    background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(34,197,94,.90));
    box-shadow: 0 14px 34px rgba(79,70,229,.22);
  }
  .t1-btn.primary:hover{ transform: translateY(-1px); filter: saturate(1.05); }
  .t1-btn.primary:active{ transform: translateY(0); }

  .t1-btn.secondary{
    color: var(--text);
    background: rgba(255,255,255,.55);
    box-shadow: 0 14px 34px rgba(15,23,42,.08);
  }
  html[data-theme="dark"] .t1-btn.secondary{ background: rgba(255,255,255,.06); }
  .t1-btn.secondary:hover{ transform: translateY(-1px); box-shadow: 0 18px 48px rgba(15,23,42,.12); }
  .t1-btn.secondary:active{ transform: translateY(0); }

  .xwrap{
    background: rgba(255,255,255,.30);
    border:1px solid var(--stroke);
    border-radius: 18px;
    overflow: hidden;
    margin-top: 14px;
  }
  html[data-theme="dark"] .xwrap{ background: rgba(255,255,255,.04); }

  .xhdr{
    font-weight: 950;
    text-align:center;
    padding: 12px 12px;
    border-bottom: 1px solid var(--stroke);
    color: var(--text);
    background: rgba(255,255,255,.35);
  }
  html[data-theme="dark"] .xhdr{ background: rgba(255,255,255,.06); }

  .xscroll{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    max-width: 100%;
  }
  .xscroll::-webkit-scrollbar{ height: 10px; }
  .xscroll::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.22); border-radius: 999px; }
  html[data-theme="dark"] .xscroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); }

  .xtable{
    border-collapse: separate;
    border-spacing: 0;
    width: max-content;
    min-width: 1600px;
    table-layout: fixed;
  }

  .xtable th,
  .xtable td{
    border-right: 1px solid rgba(15,23,42,.18);
    border-bottom: 1px solid rgba(15,23,42,.18);
    padding: 6px 6px;
    font-size: 12px;
    text-align: center;
    vertical-align: middle;
    overflow: hidden;
    color: var(--text);
    background: transparent;
  }
  html[data-theme="dark"] .xtable th,
  html[data-theme="dark"] .xtable td{
    border-right: 1px solid rgba(255,255,255,.18);
    border-bottom: 1px solid rgba(255,255,255,.18);
  }

  .xtable tr > *:first-child{ border-left: 1px solid rgba(15,23,42,.18); }
  html[data-theme="dark"] .xtable tr > *:first-child{ border-left: 1px solid rgba(255,255,255,.18); }
  .xtable thead tr:first-child > *{ border-top: 1px solid rgba(15,23,42,.18); }
  html[data-theme="dark"] .xtable thead tr:first-child > *{ border-top: 1px solid rgba(255,255,255,.18); }

  .xtable thead th{
    position: sticky;
    top: 0;
    z-index: 5;
    background: var(--surface);
    font-weight: 950;
  }

  .xtable .xname,
  .xtable .xshift{
    position: sticky;
    left: 0;
    z-index: 106;
    background: #fff;
    text-align: left;
    padding-left: 10px;
    font-weight: 950;
  }

  .vtxt{
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    white-space: nowrap;
    font-weight: 900;
    letter-spacing: .02em;
  }

  .g-green{ background: rgba(34,197,94,.10); }
  .g-blue{ background: rgba(79,70,229,.10); }
  .g-gray{ background: rgba(100,116,139,.10); }
  .g-total{ background: rgba(245,158,11,.12); }

  .xshift{ font-weight: 950; }
  .xshift.xbig{ text-align:center; font-weight: 950; font-size: 14px; }

  .xinput input{
    width: 76px;
    height: 34px;
    padding: 6px 8px;
    border:1px solid rgba(15,23,42,.18);
    border-radius: 12px;
    text-align:center;
    box-sizing:border-box;
    background: rgba(255,255,255,.55);
    color: var(--text);
    outline: none;
    transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  html[data-theme="dark"] .xinput input{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.18);
  }
  .xinput input:focus{
    border-color: rgba(99,102,241,.55);
    box-shadow: var(--ring);
    background: rgba(255,255,255,.70);
  }
  html[data-theme="dark"] .xinput input:focus{ background: rgba(255,255,255,.10); }

  .kcell input{ width: 90px; }

  /* ✅ терминал input в первой ячейке: визуально как было, но редактируемо */
  .termcell{
    width: 100%;
    height: 36px;
    padding: 6px 10px;
    border:1px solid rgba(15,23,42,.18);
    border-radius: 12px;
    background: rgba(255,255,255,.55);
    color: var(--text);
    outline: none;
    box-sizing: border-box;
    font-weight: 950;
  }
  html[data-theme="dark"] .termcell{
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.18);
  }
  .termcell:focus{
    border-color: rgba(99,102,241,.55);
    box-shadow: var(--ring);
    background: rgba(255,255,255,.70);
  }
  html[data-theme="dark"] .termcell:focus{ background: rgba(255,255,255,.10); }

  @media (max-width: 980px){
    .t1-card{ padding: 12px; border-radius: 18px; }
    .t1-title{ font-size: 16px; }
    .t1-field{ min-width: 160px; max-width: 100%; flex: 1; }
    .t1-actions{ gap: 8px; }
    .t1-btn{ width: 100%; }
    .t1-btn.primary{ order: 3; }
    .t1-btn.secondary{ order: 4; }
  }

  @media (max-width: 560px){
    .xhdr{ font-size: 12px; }
    .xtable th, .xtable td{ font-size: 11px; padding: 6px 5px; }
    .xinput input{ width: 68px; height: 32px; border-radius: 11px; }
    .kcell input{ width: 80px; }
    .xtable .xname, .xtable .xshift{ min-width: 150px; }
  }
</style>

<div class="t1-card">
  <h2 class="t1-title">
    <span data-i18n="t1_title">Jadval №1 —</span>
    {% if mode == "view" %}
      <span data-i18n="t1_mode_view">просмотр</span>
    {% else %}
      {% if is_new %}
        <span data-i18n="t1_mode_create">создание</span>
      {% else %}
        <span data-i18n="t1_mode_edit">редактирование</span>
      {% endif %}
    {% endif %}
  </h2>

  <p class="t1-muted" data-i18n="t1_help">
    ИТОГ: если поле пустое — берётся День+Ночь. Если введёшь значение — будет использовано твоё.
  </p>

  {% if error %}
    <div style="margin-top:10px; padding:10px 12px; border-radius:14px; border:1px solid var(--stroke); background: rgba(239,68,68,.10); color: var(--text); font-weight:900;">
      {{ error }}
    </div>
  {% endif %}

  <form method="post" id="t1Form">
    {% csrf_token %}

    <div class="t1-actions">
      <a class="t1-btn secondary" href="{% url 'station_table_1_list' %}">
        <span aria-hidden="true">←</span>
        <span data-i18n="back">Назад</span>
      </a>

      <div class="t1-field">
        <label data-i18n="t1_date">Дата</label>
        <input class="t1-inp" type="date" name="date" value="{{ date|date:'Y-m-d' }}" required {% if mode == "view" %}disabled{% endif %}>
      </div>

      <div class="t1-field" style="min-width:260px; max-width: 360px;">
        <label data-i18n="t1_station">Filial</label>
        <input class="t1-inp" value="{{ station_name }}" disabled>
      </div>

      {% if mode != "view" %}
        <button class="t1-btn secondary" type="button" id="btnAddTerminal">
          ＋ Добавить терминал
        </button>

        <button class="t1-btn secondary" type="submit" name="save_only" value="1">
          <span data-i18n="t1_btn_save">Сохранить</span>
        </button>

        <button class="t1-btn primary" type="submit" name="submit_report" value="1">
          {% if is_new %}
            <span>Создать и отправить</span>
          {% else %}
            <span>Отправить админу</span>
          {% endif %}
        </button>
      {% endif %}
    </div>

    <div id="terminalContainer">
      {# ✅ Рисуем 1 или N таблиц подряд (каждая таблица = терминал) #}
      {% for blk in blocks_ctx %}
        {% with b=blk.b day_obj=blk.day_obj night_obj=blk.night_obj total_obj=blk.total_obj %}
        {% with k_val=total_obj|data_val:'k_podache_so_st' %}
        {% with term_val=total_obj|data_val:'terminal_name' %}
        <div class="xwrap terminal-block" data-block="{{ b }}">
          <div class="xhdr" data-i18n="t1_hdr">
            Оперативная информация о работе логистических центров АО "Узтемирйулконтейнер" в сутки —
            {{ date|date:"d.m.Y" }} — к 18:00 час
            {% if blocks_ctx|length > 1 %} — Блок {{ b }}{% endif %}
          </div>

          <div class="xscroll">
            <table class="xtable t1-table" data-block="{{ b }}">
              <colgroup>
                <col style="width:170px;">
                <col style="width:84px;">
                <col style="width:64px;">
                {% for _ in "1234567890123456789012345678901234567890" %}
                  <col style="width:84px;">
                {% endfor %}
              </colgroup>

              <thead>
                <tr>
                  <th rowspan="4" class="xname" data-i18n="t1_col_name">Наименование ЛЦ</th>
                  <th rowspan="4" class="xname" data-i18n="t1_col_shift">Смена</th>

                  <th rowspan="2"><div class="vtxt" data-i18n="t1_col_podano">Подано на ЛЦ</div></th>
                  <th rowspan="2"><div class="vtxt" data-i18n="t1_col_kpod">к подаче со ст</div></th>

                  <th colspan="7" class="g-green" data-i18n="t1_blk_vygr">Выгрузка</th>
                  <th colspan="7" class="g-green" data-i18n="t1_blk_pod_vygr">Под выгрузкой</th>

                  <th rowspan="2"><div class="vtxt" data-i18n="t1_col_uborka">Уборка</div></th>

                  <th colspan="6" class="g-blue" data-i18n="t1_blk_pogr">Погрузка</th>
                  <th colspan="6" class="g-blue" data-i18n="t1_blk_pod_pogr">Под погрузкой</th>

                  <th colspan="2" class="g-gray" data-i18n="t1_blk_sps">Порожние СПС</th>
                  <th rowspan="2" class="g-gray" data-i18n="t1_col_income">суточные доходы</th>
                </tr>

                <tr>
                  <th class="g-green"><div class="vtxt">фт</div></th>
                  <th class="g-green"><div class="vtxt">конт.</div></th>
                  <th class="g-green"><div class="vtxt">кр</div></th>
                  <th class="g-green"><div class="vtxt">пв</div></th>
                  <th class="g-green"><div class="vtxt" data-i18n="t1_misc">прочее</div></th>
                  <th class="g-green"><div class="vtxt" data-i18n="t1_auto">Авто</div></th>
                  <th class="g-green"><div class="vtxt">конт.</div></th>

                  <th class="g-green"><div class="vtxt">фт</div></th>
                  <th class="g-green"><div class="vtxt">конт.</div></th>
                  <th class="g-green"><div class="vtxt">кр</div></th>
                  <th class="g-green"><div class="vtxt">пв</div></th>
                  <th class="g-green"><div class="vtxt" data-i18n="t1_misc">прочее</div></th>
                  <th class="g-green"><div class="vtxt" data-i18n="t1_auto">Авто</div></th>
                  <th class="g-green"><div class="vtxt">конт.</div></th>

                  <th class="g-blue"><div class="vtxt">фт</div></th>
                  <th class="g-blue"><div class="vtxt">конт.</div></th>
                  <th class="g-blue"><div class="vtxt">кр</div></th>
                  <th class="g-blue"><div class="vtxt">пв</div></th>
                  <th class="g-blue"><div class="vtxt" data-i18n="t1_misc">прочее</div></th>
                  <th class="g-blue"><div class="vtxt">конт.</div></th>

                  <th class="g-blue"><div class="vtxt">фт</div></th>
                  <th class="g-blue"><div class="vtxt">конт.</div></th>
                  <th class="g-blue"><div class="vtxt">кр</div></th>
                  <th class="g-blue"><div class="vtxt">пв</div></th>
                  <th class="g-blue"><div class="vtxt" data-i18n="t1_misc">прочее</div></th>
                  <th class="g-blue"><div class="vtxt">конт.</div></th>

                  <th class="g-gray"><div class="vtxt">ЛЦ</div></th>
                  <th class="g-gray"><div class="vtxt" data-i18n="t1_station2">СТАНЦИЯ</div></th>
                </tr>
              </thead>

              <tbody>
                <!-- DAY -->
                <tr data-row="day">
                  <td rowspan="{% if status %}3{% else %}2{% endif %}" class="xshift">
                    <input class="termcell"
                           {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__terminal__name"
                           value="{% if term_val %}{{ term_val }}{% else %}{{ day_obj|data_val:'terminal_name' }}{% endif %}"
                           placeholder="Название терминала">
                  </td>

                  <td class="xshift" data-i18n="t1_shift_day">kun</td>

                  <td class="xinput">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__day__podano_lc"
                           value="{{ day_obj|data_val:'podano_lc' }}"
                           data-key="podano_lc" inputmode="numeric">
                  </td>

                  <td rowspan="{% if status %}3{% else %}2{% endif %}" class="xinput kcell">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__common__k_podache_so_st"
                           value="{{ k_val }}"
                           inputmode="numeric">
                  </td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_ft" value="{{ day_obj|data_val:'vygr_ft' }}" data-key="vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_cont" value="{{ day_obj|data_val:'vygr_cont' }}" data-key="vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_kr" value="{{ day_obj|data_val:'vygr_kr' }}" data-key="vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_pv" value="{{ day_obj|data_val:'vygr_pv' }}" data-key="vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_proch" value="{{ day_obj|data_val:'vygr_proch' }}" data-key="vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_itogo" value="{{ day_obj|data_val:'vygr_itogo' }}" data-key="vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__vygr_itogo_kon" value="{{ day_obj|data_val:'vygr_itogo_kon' }}" data-key="vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_ft" value="{{ day_obj|data_val:'pod_vygr_ft' }}" data-key="pod_vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_cont" value="{{ day_obj|data_val:'pod_vygr_cont' }}" data-key="pod_vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_kr" value="{{ day_obj|data_val:'pod_vygr_kr' }}" data-key="pod_vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_pv" value="{{ day_obj|data_val:'pod_vygr_pv' }}" data-key="pod_vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_proch" value="{{ day_obj|data_val:'pod_vygr_proch' }}" data-key="pod_vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_itogo" value="{{ day_obj|data_val:'pod_vygr_itogo' }}" data-key="pod_vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_vygr_itogo_kon" value="{{ day_obj|data_val:'pod_vygr_itogo_kon' }}" data-key="pod_vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__uborka" value="{{ day_obj|data_val:'uborka' }}" data-key="uborka" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_ft" value="{{ day_obj|data_val:'pogr_ft' }}" data-key="pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_cont" value="{{ day_obj|data_val:'pogr_cont' }}" data-key="pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_kr" value="{{ day_obj|data_val:'pogr_kr' }}" data-key="pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_pv" value="{{ day_obj|data_val:'pogr_pv' }}" data-key="pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_proch" value="{{ day_obj|data_val:'pogr_proch' }}" data-key="pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pogr_itogo_kon" value="{{ day_obj|data_val:'pogr_itogo_kon' }}" data-key="pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_ft" value="{{ day_obj|data_val:'pod_pogr_ft' }}" data-key="pod_pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_cont" value="{{ day_obj|data_val:'pod_pogr_cont' }}" data-key="pod_pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_kr" value="{{ day_obj|data_val:'pod_pogr_kr' }}" data-key="pod_pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_pv" value="{{ day_obj|data_val:'pod_pogr_pv' }}" data-key="pod_pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_proch" value="{{ day_obj|data_val:'pod_pogr_proch' }}" data-key="pod_pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__pod_pogr_itogo_kon" value="{{ day_obj|data_val:'pod_pogr_itogo_kon' }}" data-key="pod_pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__spc_lc" value="{{ day_obj|data_val:'spc_lc' }}" data-key="spc_lc" inputmode="numeric"></td>
                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__day__spc_station" value="{{ day_obj|data_val:'spc_station' }}" data-key="spc_station" inputmode="numeric"></td>

                  <td class="xinput g-gray">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__day__income_daily"
                           value="{{ day_obj|data_val:'income_daily' }}"
                           data-key="income_daily"
                           inputmode="numeric">
                  </td>
                </tr>

                {% if status %}
                <!-- NIGHT -->
                <tr data-row="night">
                  <td class="xshift" data-i18n="t1_shift_night">tun</td>

                  <td class="xinput">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__night__podano_lc"
                           value="{{ night_obj|data_val:'podano_lc' }}"
                           data-key="podano_lc" inputmode="numeric">
                  </td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_ft" value="{{ night_obj|data_val:'vygr_ft' }}" data-key="vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_cont" value="{{ night_obj|data_val:'vygr_cont' }}" data-key="vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_kr" value="{{ night_obj|data_val:'vygr_kr' }}" data-key="vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_pv" value="{{ night_obj|data_val:'vygr_pv' }}" data-key="vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_proch" value="{{ night_obj|data_val:'vygr_proch' }}" data-key="vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_itogo" value="{{ night_obj|data_val:'vygr_itogo' }}" data-key="vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__vygr_itogo_kon" value="{{ night_obj|data_val:'vygr_itogo_kon' }}" data-key="vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_ft" value="{{ night_obj|data_val:'pod_vygr_ft' }}" data-key="pod_vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_cont" value="{{ night_obj|data_val:'pod_vygr_cont' }}" data-key="pod_vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_kr" value="{{ night_obj|data_val:'pod_vygr_kr' }}" data-key="pod_vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_pv" value="{{ night_obj|data_val:'pod_vygr_pv' }}" data-key="pod_vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_proch" value="{{ night_obj|data_val:'pod_vygr_proch' }}" data-key="pod_vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_itogo" value="{{ night_obj|data_val:'pod_vygr_itogo' }}" data-key="pod_vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_vygr_itogo_kon" value="{{ night_obj|data_val:'pod_vygr_itogo_kon' }}" data-key="pod_vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__uborka" value="{{ night_obj|data_val:'uborka' }}" data-key="uborka" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_ft" value="{{ night_obj|data_val:'pogr_ft' }}" data-key="pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_cont" value="{{ night_obj|data_val:'pogr_cont' }}" data-key="pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_kr" value="{{ night_obj|data_val:'pogr_kr' }}" data-key="pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_pv" value="{{ night_obj|data_val:'pogr_pv' }}" data-key="pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_proch" value="{{ night_obj|data_val:'pogr_proch' }}" data-key="pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pogr_itogo_kon" value="{{ night_obj|data_val:'pogr_itogo_kon' }}" data-key="pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_ft" value="{{ night_obj|data_val:'pod_pogr_ft' }}" data-key="pod_pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_cont" value="{{ night_obj|data_val:'pod_pogr_cont' }}" data-key="pod_pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_kr" value="{{ night_obj|data_val:'pod_pogr_kr' }}" data-key="pod_pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_pv" value="{{ night_obj|data_val:'pod_pogr_pv' }}" data-key="pod_pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_proch" value="{{ night_obj|data_val:'pod_pogr_proch' }}" data-key="pod_pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__pod_pogr_itogo_kon" value="{{ night_obj|data_val:'pod_pogr_itogo_kon' }}" data-key="pod_pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__spc_lc" value="{{ night_obj|data_val:'spc_lc' }}" data-key="spc_lc" inputmode="numeric"></td>
                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__night__spc_station" value="{{ night_obj|data_val:'spc_station' }}" data-key="spc_station" inputmode="numeric"></td>

                  <td class="xinput g-gray">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__night__income_daily"
                           value="{{ night_obj|data_val:'income_daily' }}"
                           data-key="income_daily"
                           inputmode="numeric">
                  </td>
                </tr>
                {% endif %}

                <!-- TOTAL -->
                <tr class="g-total" data-row="total">
                  <td class="xshift xbig" data-i18n="t1_total">ИТОГ</td>

                  <td class="xinput">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__total__podano_lc"
                           value="{{ total_obj|data_val:'podano_lc' }}"
                           data-total-key="podano_lc"
                           inputmode="numeric">
                  </td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_ft" value="{{ total_obj|data_val:'vygr_ft' }}" data-total-key="vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_cont" value="{{ total_obj|data_val:'vygr_cont' }}" data-total-key="vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_kr" value="{{ total_obj|data_val:'vygr_kr' }}" data-total-key="vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_pv" value="{{ total_obj|data_val:'vygr_pv' }}" data-total-key="vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_proch" value="{{ total_obj|data_val:'vygr_proch' }}" data-total-key="vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_itogo" value="{{ total_obj|data_val:'vygr_itogo' }}" data-total-key="vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__vygr_itogo_kon" value="{{ total_obj|data_val:'vygr_itogo_kon' }}" data-total-key="vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_ft" value="{{ total_obj|data_val:'pod_vygr_ft' }}" data-total-key="pod_vygr_ft" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_cont" value="{{ total_obj|data_val:'pod_vygr_cont' }}" data-total-key="pod_vygr_cont" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_kr" value="{{ total_obj|data_val:'pod_vygr_kr' }}" data-total-key="pod_vygr_kr" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_pv" value="{{ total_obj|data_val:'pod_vygr_pv' }}" data-total-key="pod_vygr_pv" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_proch" value="{{ total_obj|data_val:'pod_vygr_proch' }}" data-total-key="pod_vygr_proch" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_itogo" value="{{ total_obj|data_val:'pod_vygr_itogo' }}" data-total-key="pod_vygr_itogo" inputmode="numeric"></td>
                  <td class="xinput g-green"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_vygr_itogo_kon" value="{{ total_obj|data_val:'pod_vygr_itogo_kon' }}" data-total-key="pod_vygr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__uborka" value="{{ total_obj|data_val:'uborka' }}" data-total-key="uborka" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_ft" value="{{ total_obj|data_val:'pogr_ft' }}" data-total-key="pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_cont" value="{{ total_obj|data_val:'pogr_cont' }}" data-total-key="pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_kr" value="{{ total_obj|data_val:'pogr_kr' }}" data-total-key="pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_pv" value="{{ total_obj|data_val:'pogr_pv' }}" data-total-key="pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_proch" value="{{ total_obj|data_val:'pogr_proch' }}" data-total-key="pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pogr_itogo_kon" value="{{ total_obj|data_val:'pogr_itogo_kon' }}" data-total-key="pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_ft" value="{{ total_obj|data_val:'pod_pogr_ft' }}" data-total-key="pod_pogr_ft" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_cont" value="{{ total_obj|data_val:'pod_pogr_cont' }}" data-total-key="pod_pogr_cont" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_kr" value="{{ total_obj|data_val:'pod_pogr_kr' }}" data-total-key="pod_pogr_kr" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_pv" value="{{ total_obj|data_val:'pod_pogr_pv' }}" data-total-key="pod_pogr_pv" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_proch" value="{{ total_obj|data_val:'pod_pogr_proch' }}" data-total-key="pod_pogr_proch" inputmode="numeric"></td>
                  <td class="xinput g-blue"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__pod_pogr_itogo_kon" value="{{ total_obj|data_val:'pod_pogr_itogo_kon' }}" data-total-key="pod_pogr_itogo_kon" inputmode="numeric"></td>

                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__spc_lc" value="{{ total_obj|data_val:'spc_lc' }}" data-total-key="spc_lc" inputmode="numeric"></td>
                  <td class="xinput g-gray"><input {% if mode == "view" %}disabled{% endif %} name="b{{ b }}__total__spc_station" value="{{ total_obj|data_val:'spc_station' }}" data-total-key="spc_station" inputmode="numeric"></td>

                  <td class="xinput g-gray">
                    <input {% if mode == "view" %}disabled{% endif %}
                           name="b{{ b }}__total__income_daily"
                           value="{{ total_obj|data_val:'income_daily' }}"
                           data-total-key="income_daily"
                           inputmode="numeric">
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        {% endwith %}
        {% endwith %}
        {% endwith %}
      {% endfor %}
    </div>
  </form>
</div>

<script>
(function(){
  // ====== Auto placeholders (как было) ======
  document.querySelectorAll(".t1-table").forEach((table)=>{
    const dayRow = table.querySelector('tr[data-row="day"]');
    const nightRow = table.querySelector('tr[data-row="night"]'); // может быть null
    const totalInputs = table.querySelectorAll('input[data-total-key]');

    function val(row, key){
      if(!row) return 0;
      const inp = row.querySelector('input[data-key="'+key+'"]');
      if(!inp) return 0;
      const n = parseInt((inp.value||"0").replace(/\s+/g,''), 10);
      return isNaN(n) ? 0 : n;
    }

    function calcAuto(){
      let incomeAuto = 0;

      totalInputs.forEach(inp=>{
        const key = inp.getAttribute("data-total-key");
        if(key === "income_daily") return;

        const auto = val(dayRow, key) + val(nightRow, key);
        inp.placeholder = auto;
        incomeAuto += auto;
      });

      const incomeInp = table.querySelector('input[data-total-key="income_daily"]');
      if(incomeInp && !incomeInp.value){
        incomeInp.placeholder = incomeAuto;
      }
    }

    table.addEventListener("input", calcAuto);
    calcAuto();
  });

  // ====== Добавить терминал (клонирование таблицы 1:1) ======
  const btn = document.getElementById("btnAddTerminal");
  const container = document.getElementById("terminalContainer");
  const mode = "{{ mode|default:'edit' }}";
  const canEdit = (mode !== "view");

  function nextBlock(){
    let maxB = 0;
    container.querySelectorAll(".terminal-block").forEach(w=>{
      const b = parseInt(w.getAttribute("data-block") || "0", 10);
      if(!isNaN(b)) maxB = Math.max(maxB, b);
    });
    return maxB + 1;
  }

  function replacePrefix(name, newB){
    return name.replace(/^b\d+__/, "b"+newB+"__");
  }

  function clearTerminalBlock(wrap){
    // очищаем все input кроме date (его внутри wrap нет)
    wrap.querySelectorAll("input").forEach(inp=>{
      if(inp.name && inp.name.includes("__terminal__name")){
        inp.value = "";
        return;
      }
      if(inp.name && inp.name.includes("__common__k_podache_so_st")){
        inp.value = "";
        return;
      }
      // остальные числовые
      if(inp.type === "number" || inp.inputMode === "numeric" || /__day__|__night__|__total__/.test(inp.name||"")){
        inp.value = "";
        inp.placeholder = "";
      }
    });
  }

  function rebindAutoForTable(table){
    const dayRow = table.querySelector('tr[data-row="day"]');
    const nightRow = table.querySelector('tr[data-row="night"]');
    const totalInputs = table.querySelectorAll('input[data-total-key]');

    function val(row, key){
      if(!row) return 0;
      const inp = row.querySelector('input[data-key="'+key+'"]');
      if(!inp) return 0;
      const n = parseInt((inp.value||"0").replace(/\s+/g,''), 10);
      return isNaN(n) ? 0 : n;
    }

    function calcAuto(){
      let incomeAuto = 0;
      totalInputs.forEach(inp=>{
        const key = inp.getAttribute("data-total-key");
        if(key === "income_daily") return;
        const auto = val(dayRow, key) + val(nightRow, key);
        inp.placeholder = auto;
        incomeAuto += auto;
      });
      const incomeInp = table.querySelector('input[data-total-key="income_daily"]');
      if(incomeInp && !incomeInp.value){
        incomeInp.placeholder = incomeAuto;
      }
    }

    table.addEventListener("input", calcAuto);
    calcAuto();
  }

  function addTerminal(){
    if(!canEdit) return;
    const blocks = container.querySelectorAll(".terminal-block");
    if(!blocks.length) return;

    const last = blocks[blocks.length - 1];
    const clone = last.cloneNode(true);

    const newB = nextBlock();
    clone.setAttribute("data-block", String(newB));

    // обновляем data-block у table
    clone.querySelectorAll("table.t1-table").forEach(t=>{
      t.setAttribute("data-block", String(newB));
    });

    // обновляем name у всех инпутов bX__...
    clone.querySelectorAll("[name]").forEach(el=>{
      const n = el.getAttribute("name");
      if(!n) return;
      el.setAttribute("name", replacePrefix(n, newB));
    });

    // включаем (если вдруг было disabled из view)
    clone.querySelectorAll("input").forEach(inp=>{
      inp.disabled = false;
    });

    clearTerminalBlock(clone);

    container.appendChild(clone);

    // перепривязать авто-плейсхолдеры на новом table
    clone.querySelectorAll("table.t1-table").forEach(rebindAutoForTable);
  }

  if(btn) btn.addEventListener("click", addTerminal);
})();
</script>

<script>
(function(){
  const dict = {
    ru: {
      t1_title: "Таблица №1 —",
      t1_mode_view: "просмотр",
      t1_mode_create: "создание",
      t1_mode_edit: "редактирование",
      t1_help: "ИТОГ: если поле пустое — берётся День+Ночь. Если введёшь значение — будет использовано твоё.",
      t1_date: "Дата",
      t1_station: "Станция",
      t1_btn_create: "Создать отчёт",
      t1_btn_save: "Сохранить",
      back: "Назад",
      t1_hdr: "Оперативная информация о работе логистических центров АО \"Узтемирйулконтейнер\" в сутки —",
      t1_col_name: "Наименование ЛЦ",
      t1_col_podano: "Подано на ЛЦ",
      t1_col_kpod: "к подаче со ст",
      t1_blk_vygr: "Выгрузка",
      t1_blk_pod_vygr: "Под выгрузкой",
      t1_col_uborka: "Уборка",
      t1_blk_pogr: "Погрузка",
      t1_blk_pod_pogr: "Под погрузкой",
      t1_blk_sps: "Порожние СПС",
      t1_col_income: "суточные доходы",
      t1_misc: "прочее",
      t1_auto: "Авто",
      t1_station2: "СТАНЦИЯ",
      t1_total: "ИТОГ",
      t1_shift_day: "kun",
      t1_shift_night: "tun",
    },
    uz: {
      t1_title: "Hisobot №1 —",
      t1_mode_view: "ko‘rish",
      t1_mode_create: "yaratish",
      t1_mode_edit: "tahrirlash",
      t1_help: "JAMI: maydon bo‘sh bo‘lsa — Kun+Tun yig‘indisi olinadi. Qiymat kiritsangiz — shu qiymat ishlatiladi.",
      t1_date: "Sana",
      t1_station: "Filial",
      t1_btn_create: "Hisobot yaratish",
      t1_btn_save: "Saqlash",
      back: "Ortga",
      t1_hdr: "\"O‘ztemiryo‘lkonteyner\" AJ logistika markazlari bo‘yicha sutkalik operativ ma’lumot —",
      t1_col_name: "LM nomi",
      t1_col_podano: "LMga berildi",
      t1_col_kpod: "St’dan berishga",
      t1_blk_vygr: "Tushirish",
      t1_blk_pod_vygr: "Tushirishda",
      t1_col_uborka: "Yig‘ishtirish",
      t1_blk_pogr: "Yuklash",
      t1_blk_pod_pogr: "Yuklashda",
      t1_blk_sps: "Bo‘sh SPS",
      t1_col_income: "sutkalik daromad",
      t1_misc: "boshqa",
      t1_auto: "Avto",
      t1_station2: "STANSIYA",
      t1_total: "JAMI",
      t1_shift_day: "kun",
      t1_shift_night: "tun",
    }
  };

  function getLang(){
    const saved = localStorage.getItem('lang') || (document.documentElement.getAttribute('data-lang') || 'ru');
    return (saved === 'uz') ? 'uz' : 'ru';
  }

  function applyLocalLang(){
    const lang = getLang();
    const t = dict[lang] || dict.ru;

    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      if (t[k] !== undefined) el.textContent = t[k];
    });
  }

  applyLocalLang();

  const langBtn = document.getElementById('langBtn');
  if(langBtn){
    langBtn.addEventListener('click', () => setTimeout(applyLocalLang, 0));
  }

  window.addEventListener('storage', (e)=>{
    if(e.key === 'lang') applyLocalLang();
  });
})();
</script>
{% endblock %}