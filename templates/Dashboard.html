{% extends "base.html" %}
{% load static %}
{% load humanize %}
{# report_extras kerak boâ€˜lsa qoldir #}
{% load report_extras %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  /* =========================
     DASHBOARD (works with html[data-theme="dark"] and language switch)
  ========================= */
  .db{
    max-width:1280px;
    margin:0 auto;
    padding:0 12px 18px;
    box-sizing:border-box;
  }

  .db-head{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin:6px 0 14px;
  }

  .db-title{
    margin:0;
    font-size:22px;
    font-weight:950;
    letter-spacing:-.02em;
    color:var(--text);
  }
  .db-sub{
    margin:6px 0 0;
    color:var(--muted);
    font-size:13px;
    line-height:1.4;
  }

  .db-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btnx{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    height:42px;
    padding:0 14px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.70);
    color:var(--text);
    font-weight:950;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease, background .12s ease;
    box-shadow:0 10px 22px rgba(15,23,42,.10);
    white-space:nowrap;
  }
  html[data-theme="dark"] .btnx{
    background:rgba(255,255,255,.08);
    box-shadow:0 14px 30px rgba(0,0,0,.35);
  }
  .btnx:hover{ transform:translateY(-1px); filter:saturate(1.05); }
  .btnx:active{ transform:translateY(0); }

  .btnx.primary{
    color:#fff;
    border-color:rgba(37,99,235,.35);
    background:linear-gradient(135deg, rgba(37,99,235,.96), rgba(16,185,129,.92));
    box-shadow:0 14px 28px rgba(37,99,235,.18);
  }
  html[data-theme="dark"] .btnx.primary{
    border-color:rgba(99,102,241,.40);
    box-shadow:0 16px 36px rgba(0,0,0,.45);
  }

  /* =========================
     GRID
  ========================= */
  .grid-kpi{
    display:grid;
    grid-template-columns:repeat(4, minmax(0, 1fr));
    gap:12px;
    margin-bottom:12px;
  }
  @media (max-width: 1100px){
    .grid-kpi{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 560px){
    .grid-kpi{ grid-template-columns:1fr; }
    .db-actions .btnx{ width:100%; }
  }

  .grid-main{
    display:grid;
    grid-template-columns:1.25fr .75fr;
    gap:12px;
    align-items:start;
    margin-bottom:12px;
  }
  @media (max-width: 980px){
    .grid-main{ grid-template-columns:1fr; }
  }

  .grid-bottom{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    align-items:start;
  }
  @media (max-width: 980px){
    .grid-bottom{ grid-template-columns:1fr; }
  }

  /* =========================
     CARD
  ========================= */
  .cardx{
    background:var(--surface);
    border:1px solid var(--stroke);
    border-radius:20px;
    box-shadow:var(--shadow);
    padding:14px;
    backdrop-filter: blur(14px);
    overflow:hidden;
  }
  .cardx-h{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .cardx-title{
    margin:0;
    font-size:14px;
    font-weight:950;
    color:var(--text);
    letter-spacing:-.01em;
  }
  .cardx-sub{
    margin-top:6px;
    color:var(--muted);
    font-size:12.5px;
    line-height:1.35;
  }

  /* =========================
     KPI CARD
  ========================= */
  .kpi{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
    min-height:84px;
  }
  .kpi .val{
    font-size:24px;
    font-weight:1000;
    letter-spacing:-.02em;
    color:var(--text);
    margin-top:6px;
  }
  .kpi .meta{
    color:var(--muted);
    font-size:12.5px;
    margin-top:6px;
    line-height:1.35;
  }
  .kpi .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.35);
    font-size:12px;
    font-weight:900;
    color:var(--text);
    white-space:nowrap;
  }
  html[data-theme="dark"] .kpi .chip{ background:rgba(255,255,255,.06); }

  .dot{width:8px;height:8px;border-radius:999px;background:rgba(16,185,129,.95)}
  .dot.warn{background:rgba(245,158,11,.95)}
  .dot.bad{background:rgba(239,68,68,.95)}

  /* =========================
     CHART AREA
  ========================= */
  .chart{
    width:100%;
    height:320px;
    position:relative;
  }
  @media (max-width: 560px){
    .chart{ height:260px; }
  }

  /* =========================
     TABLE
  ========================= */
  .table-wrap{
    border:1px solid var(--stroke);
    border-radius:16px;
    overflow:hidden;
    background:rgba(255,255,255,.25);
  }
  html[data-theme="dark"] .table-wrap{ background:rgba(255,255,255,.04); }

  .tbl{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:760px;
  }
  .tbl th, .tbl td{
    padding:10px 10px;
    border-bottom:1px solid var(--stroke);
    text-align:left;
    font-size:12.8px;
    color:var(--text);
  }
  .tbl th{
    font-weight:950;
    position:sticky;
    top:0;
    z-index:1;
    background:rgba(255,255,255,.55);
  }
  html[data-theme="dark"] .tbl th{ background:rgba(255,255,255,.06); }

  .tbl tr:hover td{ background:rgba(2,132,199,.05); }
  html[data-theme="dark"] .tbl tr:hover td{ background:rgba(99,102,241,.10); }

  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  .right{text-align:right}
  .scroll-x{overflow:auto}
  .scroll-x::-webkit-scrollbar{height:10px}
  .scroll-x::-webkit-scrollbar-thumb{background:rgba(15,23,42,.18);border-radius:999px}
  html[data-theme="dark"] .scroll-x::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14)}
</style>

<div class="db">

  <div class="db-head">
    <div>
      <h1 class="db-title" data-i18n="db_title">Dashboard</h1>
      <div class="db-sub">
        <span data-i18n="db_sub">Kunlik operativ koâ€˜rsatkichlar, kun/tun kesimi va oxirgi hisobotlar</span>
      </div>
    </div>

    <div class="db-actions">
      <a class="btnx" href="{% url 'station_table_1_list' %}">
        <span>ðŸ“„</span><span data-i18n="go_t1">Table-1</span>
      </a>
      <a class="btnx" href="{% url 'station_table_2_list' %}">
        <span>ðŸ“„</span><span data-i18n="go_t2">Table-2</span>
      </a>
      <a class="btnx primary" href="#">
        <span>âŸ³</span><span data-i18n="refresh">Yangilash</span>
      </a>
    </div>
  </div>

  <!-- KPI -->
  <div class="grid-kpi">
    <div class="cardx">
      <div class="kpi">
        <div>
          <div class="cardx-title" data-i18n="kpi_reports_today">Bugungi hisobotlar</div>
          <div class="val mono">{{ kpi.reports_today|default:"0" }}</div>
          <div class="meta">
            <span data-i18n="kpi_reports_today_sub">Table-1 + Table-2 boâ€˜yicha</span>
          </div>
        </div>
        <div class="chip"><span class="dot"></span><span data-i18n="live">Live</span></div>
      </div>
    </div>

    <div class="cardx">
      <div class="kpi">
        <div>
          <div class="cardx-title" data-i18n="kpi_income_today">SuÑ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´</div>
          <div class="val mono">{{ kpi.income_today|default:"0"|intcomma }}</div>
          <div class="meta">
            <span data-i18n="kpi_income_today_sub">Bugun yigâ€˜ilgan daromad</span>
          </div>
        </div>
        <div class="chip"><span class="dot warn"></span><span data-i18n="today">Today</span></div>
      </div>
    </div>

    <div class="cardx">
      <div class="kpi">
        <div>
          <div class="cardx-title" data-i18n="kpi_active_stations">Faol stansiyalar</div>
          <div class="val mono">{{ kpi.active_stations|default:"0" }}</div>
          <div class="meta">
            <span data-i18n="kpi_active_stations_sub">Hisobot topshirganlar</span>
          </div>
        </div>
        <div class="chip"><span class="dot"></span><span data-i18n="ok">OK</span></div>
      </div>
    </div>

    <div class="cardx">
      <div class="kpi">
        <div>
          <div class="cardx-title" data-i18n="kpi_missing">Topshirmaganlar</div>
          <div class="val mono">{{ kpi.missing_stations|default:"0" }}</div>
          <div class="meta">
            <span data-i18n="kpi_missing_sub">Bugun yoâ€˜q boâ€˜lganlar</span>
          </div>
        </div>
        <div class="chip"><span class="dot bad"></span><span data-i18n="attention">Attention</span></div>
      </div>
    </div>
  </div>

  <!-- MAIN: big chart + side chart -->
  <div class="grid-main">
    <div class="cardx">
      <div class="cardx-h">
        <div>
          <h3 class="cardx-title" data-i18n="ch_income_30">Daromad dinamikasi (30 kun)</h3>
          <div class="cardx-sub" data-i18n="ch_income_30_sub">Kunlik daromad trendi</div>
        </div>
        <div class="chip mono">{{ kpi.range_label|default:"30d" }}</div>
      </div>
      <div class="chart">
        <canvas id="chIncome"></canvas>
      </div>
    </div>

    <div class="cardx">
      <div class="cardx-h">
        <div>
          <h3 class="cardx-title" data-i18n="ch_day_night">Kun/Tun kesimi</h3>
          <div class="cardx-sub" data-i18n="ch_day_night_sub">Top-5 stansiya (bugun)</div>
        </div>
      </div>
      <div class="chart" style="height:320px">
        <canvas id="chDayNight"></canvas>
      </div>
    </div>
  </div>

  <!-- BOTTOM: recent + pie -->
  <div class="grid-bottom">
    <div class="cardx">
      <div class="cardx-h">
        <div>
          <h3 class="cardx-title" data-i18n="recent_reports">Oxirgi hisobotlar</h3>
          <div class="cardx-sub" data-i18n="recent_reports_sub">Soâ€˜nggi 15 ta yozuv</div>
        </div>
        <a class="btnx" href="{% url 'admin_table1_reports' %}">
          <span>ðŸ”Ž</span><span data-i18n="open_admin">Admin</span>
        </a>
      </div>

      <div class="table-wrap">
        <div class="scroll-x">
          <table class="tbl">
            <thead>
              <tr>
                <th data-i18n="th_date">Sana</th>
                <th data-i18n="th_station">Stansiya</th>
                <th data-i18n="th_type">Tur</th>
                <th class="right" data-i18n="th_income">Daromad</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent %}
                <tr>
                  <td class="mono">{{ r.date }}</td>
                  <td><b>{{ r.station }}</b></td>
                  <td class="mono">{{ r.kind }}</td>
                  <td class="right mono">{{ r.income|default:0|intcomma }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="mono" style="color:var(--muted)" data-i18n="no_data">Maâ€™lumot yoâ€˜q</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="cardx">
      <div class="cardx-h">
        <div>
          <h3 class="cardx-title" data-i18n="ch_structure">Koâ€˜rsatkichlar tarkibi</h3>
          <div class="cardx-sub" data-i18n="ch_structure_sub">Bugun (Table-1 asosiy bloklar)</div>
        </div>
      </div>
      <div class="chart" style="height:360px">
        <canvas id="chStructure"></canvas>
      </div>
    </div>
  </div>

</div>

<!-- ===== JSON from backend ===== -->
{{ dash_json|json_script:"dash-json" }}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
(function(){
  // ---------- read data ----------
  const rawEl = document.getElementById("dash-json");
  let D = {};
  try{ D = JSON.parse(rawEl.textContent || "{}"); }catch(e){ D = {}; }

  // expected structure (you will provide):
  // D = {
  //   lang: "uz"|"ru",
  //   income30: { labels:[...], values:[...] },
  //   dayNightTop: { labels:[...], day:[...], night:[...] },
  //   structure: { labels:[...], values:[...] }
  // }

  // ---------- charts ----------
  const ctxIncome = document.getElementById("chIncome");
  const ctxDN = document.getElementById("chDayNight");
  const ctxStruct = document.getElementById("chStructure");

  const incomeLabels = (D.income30 && D.income30.labels) || [];
  const incomeValues = (D.income30 && D.income30.values) || [];

  const dnLabels = (D.dayNightTop && D.dayNightTop.labels) || [];
  const dnDay = (D.dayNightTop && D.dayNightTop.day) || [];
  const dnNight = (D.dayNightTop && D.dayNightTop.night) || [];

  const stLabels = (D.structure && D.structure.labels) || [];
  const stValues = (D.structure && D.structure.values) || [];

  if(ctxIncome){
    new Chart(ctxIncome, {
      type:"line",
      data:{
        labels: incomeLabels,
        datasets:[{
          label:"Income",
          data: incomeValues,
          tension:.35,
          fill:true
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{ mode:"index", intersect:false }
        },
        scales:{
          x:{ grid:{ display:false } },
          y:{ beginAtZero:true, ticks:{ precision:0 } }
        }
      }
    });
  }

  if(ctxDN){
    new Chart(ctxDN, {
      type:"bar",
      data:{
        labels: dnLabels,
        datasets:[
          { label:"Day", data: dnDay, stack:"s" },
          { label:"Night", data: dnNight, stack:"s" }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{
          x:{ stacked:true, grid:{ display:false } },
          y:{ stacked:true, beginAtZero:true, ticks:{ precision:0 } }
        }
      }
    });
  }

  if(ctxStruct){
    new Chart(ctxStruct, {
      type:"doughnut",
      data:{
        labels: stLabels,
        datasets:[{ data: stValues }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        cutout:"62%"
      }
    });
  }

  // ---------- i18n (page-level) ----------
  // Uses the same localStorage keys you were using previously.
  const dict = {
    uz:{
      db_title:"Dashboard",
      db_sub:"Kunlik operativ koâ€˜rsatkichlar, kun/tun kesimi va oxirgi hisobotlar",
      go_t1:"Table-1",
      go_t2:"Table-2",
      refresh:"Yangilash",
      kpi_reports_today:"Bugungi hisobotlar",
      kpi_reports_today_sub:"Table-1 + Table-2 boâ€˜yicha",
      kpi_income_today:"SuÑ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´",
      kpi_income_today_sub:"Bugun yigâ€˜ilgan daromad",
      kpi_active_stations:"Faol stansiyalar",
      kpi_active_stations_sub:"Hisobot topshirganlar",
      kpi_missing:"Topshirmaganlar",
      kpi_missing_sub:"Bugun yoâ€˜q boâ€˜lganlar",
      live:"Live", today:"Today", ok:"OK", attention:"Attention",
      ch_income_30:"Daromad dinamikasi (30 kun)",
      ch_income_30_sub:"Kunlik daromad trendi",
      ch_day_night:"Kun/Tun kesimi",
      ch_day_night_sub:"Top-5 stansiya (bugun)",
      recent_reports:"Oxirgi hisobotlar",
      recent_reports_sub:"Soâ€˜nggi 15 ta yozuv",
      open_admin:"Admin",
      th_date:"Sana",
      th_station:"Stansiya",
      th_type:"Tur",
      th_income:"Daromad",
      no_data:"Maâ€™lumot yoâ€˜q",
      ch_structure:"Koâ€˜rsatkichlar tarkibi",
      ch_structure_sub:"Bugun (Table-1 asosiy bloklar)"
    },
    ru:{
      db_title:"Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´",
      db_sub:"ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸, Ñ€Ð°Ð·Ñ€ÐµÐ· Ð´ÐµÐ½ÑŒ/Ð½Ð¾Ñ‡ÑŒ Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹",
      go_t1:"Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°-1",
      go_t2:"Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°-2",
      refresh:"ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ",
      kpi_reports_today:"ÐžÑ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ",
      kpi_reports_today_sub:"Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°-1 + Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°-2",
      kpi_income_today:"Ð¡ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´",
      kpi_income_today_sub:"Ð”Ð¾Ñ…Ð¾Ð´ Ð·Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ",
      kpi_active_stations:"ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¸",
      kpi_active_stations_sub:"Ð¡Ð´Ð°Ð²ÑˆÐ¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚",
      kpi_missing:"ÐÐµ ÑÐ´Ð°Ð»Ð¸",
      kpi_missing_sub:"ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÑÐµÐ³Ð¾Ð´Ð½Ñ",
      live:"Live", today:"Today", ok:"OK", attention:"Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ",
      ch_income_30:"Ð”Ð¸Ð½Ð°Ð¼Ð¸ÐºÐ° Ð´Ð¾Ñ…Ð¾Ð´Ð° (30 Ð´Ð½ÐµÐ¹)",
      ch_income_30_sub:"Ð¢Ñ€ÐµÐ½Ð´ Ð¿Ð¾ Ð´Ð½ÑÐ¼",
      ch_day_night:"Ð”ÐµÐ½ÑŒ/ÐÐ¾Ñ‡ÑŒ",
      ch_day_night_sub:"Ð¢Ð¾Ð¿-5 ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¹ (ÑÐµÐ³Ð¾Ð´Ð½Ñ)",
      recent_reports:"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹",
      recent_reports_sub:"ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 15 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹",
      open_admin:"ÐÐ´Ð¼Ð¸Ð½",
      th_date:"Ð”Ð°Ñ‚Ð°",
      th_station:"Ð¡Ñ‚Ð°Ð½Ñ†Ð¸Ñ",
      th_type:"Ð¢Ð¸Ð¿",
      th_income:"Ð”Ð¾Ñ…Ð¾Ð´",
      no_data:"ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
      ch_structure:"Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÐµÐ¹",
      ch_structure_sub:"Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ (Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð±Ð»Ð¾ÐºÐ¸ Ð¢Ð°Ð±Ð».1)"
    }
  };

  const saved = localStorage.getItem("lang") || localStorage.getItem("ui_lang") || D.lang || "uz";
  const lang = (saved === "ru") ? "ru" : "uz";

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(dict[lang] && dict[lang][key]) el.textContent = dict[lang][key];
  });

  // IMPORTANT:
  // base.html language button bosilganda "custom event" yoq bo'lmasa ham,
  // bu dashboard har safar ochilganda localStorage'dan o'qib yangilanadi.
})();
</script>
{% endblock %}
