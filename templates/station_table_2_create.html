{% extends "base.html" %}
{% load report_extras %}

{% block title %}
Таблица 2 — {% if mode == 'view' %}Просмотр{% else %}Создание/Редактирование{% endif %}
{% endblock %}

{% block content %}
<style>
  .wrap2{
    background:#fff;
    border:1px solid #111;
    border-radius:10px;
    overflow:auto;
    padding:10px;
  }

  .t2{
    border-collapse:collapse;
    width:100%;
    min-width:980px;
    table-layout:fixed;
  }
  .t2 th,.t2 td{
    border:1px solid #111;
    padding:4px 6px;
    font-size:12px;
    vertical-align:middle;
  }
  .center{text-align:center}
  .bold{font-weight:900}
  .headDate{
    text-align:center;
    font-weight:900;
    font-size:13px;
    padding:6px 8px;
  }

  .t2 input{
    width:100%;
    height:30px;
    padding:4px 8px;
    border:1px solid #94a3b8;
    border-radius:10px;
    text-align:center;
    font-weight:800;
    box-sizing:border-box;
    background:#fff;
  }
  .t2 input[disabled]{background:#f3f4f6;color:#111}

  .secTitle{
    font-weight:900;
    text-align:center;
    padding:6px 8px;
    background:#f8fafc;
  }
  .danger{color:#b91c1c;font-weight:900}
  .muted{color:#64748b}

  .actions{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center; margin:0 0 10px;
  }
</style>

<div class="card">
  <h2 style="margin:0 0 8px;">Таблица №2 — {% if mode == 'view' %}Просмотр{% else %}Создание/Редактирование{% endif %}</h2>

  <div class="actions">
    {% if mode != 'view' %}
      <button type="submit" form="t2form" class="btn">Сохранить</button>
    {% endif %}
    <a href="{% url 'station_table_2_list' %}" class="btn" style="text-decoration:none;background:#e5e7eb;color:#111;border:1px solid #cbd5e1;">
      ← Назад
    </a>
  </div>

  <form id="t2form" method="post">
    {% csrf_token %}

    <div class="wrap2">

      <!-- ================= ОСНОВНАЯ ТАБЛИЦА (6 колонок как на фото) ================= -->
      <table class="t2">
        <colgroup>
          <col style="width:60px;">
          <col>
          <col style="width:140px;">
          <col style="width:80px;">
          <col style="width:110px;">
          <col style="width:110px;">
        </colgroup>

        <thead>
          <tr>
            <th colspan="6" class="headDate">{{ date|date:"d.m.Y" }}</th>
          </tr>
          <tr>
            <th class="center bold" rowspan="2">№ п/п</th>
            <th class="center bold" colspan="2" rowspan="2">Наименование показателя</th>
            <th class="center bold">Код</th>
            <th class="center bold">
              {{ station_name }}
              <div style="font-size:11px;font-weight:900;margin-top:2px;">всего</div>
            </th>
            <th class="center bold">
              {{ station_name }}
              <div style="font-size:11px;font-weight:900;margin-top:2px;">ктк</div>
            </th>
          </tr>
          <tr>
            <th class="center bold" style="font-size:11px;">пок-ля</th>
            <th class="center bold" style="font-size:11px;">72000</th>
            <th class="center bold" style="font-size:11px;"></th>
          </tr>
        </thead>

        <tbody>
          {% for n,label,code,k_total,k_ktk in rows_def %}

            {# --- ГРУППА №8: Принято на баланс + Изъято из резерва --- #}
            {% if n == 8 %}
              <tr>
                <td class="center bold" rowspan="2">8</td>
                <td colspan="2">{{ label }}</td>
                <td class="center">{{ code }}</td>
                <td class="center">
                  <input name="{{ k_total }}" value="{{ obj|data_val:k_total }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
                <td class="center">
                  <input name="{{ k_ktk }}" value="{{ obj|data_val:k_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
              </tr>

              {# Вторая строка группы №8 берётся из строки с n==9 (Изъято из резерва) #}
              {% for n2,label2,code2,k_total2,k_ktk2 in rows_def %}
                {% if n2 == 9 %}
                  <tr>
                    <td colspan="2">{{ label2 }}</td>
                    <td class="center">{{ code2 }}</td>
                    <td class="center">
                      <input name="{{ k_total2 }}" value="{{ obj|data_val:k_total2 }}" {% if mode == 'view' %}disabled{% endif %}>
                    </td>
                    <td class="center">
                      <input name="{{ k_ktk2 }}" value="{{ obj|data_val:k_ktk2 }}" {% if mode == 'view' %}disabled{% endif %}>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}

            {# --- Строку 9 отдельно НЕ рисуем, потому что она уже показана внутри №8 --- #}
            {% elif n == 9 %}
              {# skip #}

            {# --- ГРУППА "Загружено": Гружёные/Порожние --- #}
            {% elif n == 22 %}
              <tr>
                {# после склейки 8/9 все номера сдвигаются на -1, значит 22 показываем как 21 #}
                <td class="center bold" rowspan="2">21</td>
                <td class="bold" rowspan="2">Загружено</td>
                <td class="bold">Гружёные</td>
                <td class="center">З/г</td>
                <td class="center">
                  <input name="{{ k_total }}" value="{{ obj|data_val:k_total }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
                <td class="center">
                  <input name="{{ k_ktk }}" value="{{ obj|data_val:k_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
              </tr>

              <tr>
                <td class="bold">Порожние</td>
                <td class="center">З/п</td>
                <td class="center">
                  <input name="r22p_total" value="{{ obj|data_val:'r22p_total' }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
                <td class="center">
                  <input name="r22p_ktk" value="{{ obj|data_val:'r22p_ktk' }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
              </tr>

            {# --- Все остальные строки обычные: Наименование colspan=2 --- #}
            {% else %}
              <tr>
                {# если n >= 10 — показываем номер n-1, чтобы не было пропуска #}
                <td class="center bold">
                  {% if n >= 10 %}{{ n|add:"-1" }}{% else %}{{ n }}{% endif %}
                </td>
                <td colspan="2">{{ label }}</td>
                <td class="center">{{ code }}</td>
                <td class="center">
                  <input name="{{ k_total }}" value="{{ obj|data_val:k_total }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
                <td class="center">
                  <input name="{{ k_ktk }}" value="{{ obj|data_val:k_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
                </td>
              </tr>
            {% endif %}

          {% endfor %}
        </tbody>
      </table>

      <!-- ================= НИЖНИЙ БЛОК (3 КОЛОНКИ) ================= -->
      <table class="t2" style="margin-top:10px;">
        <colgroup>
          <col>
          <col style="width:140px;">
          <col style="width:140px;">
        </colgroup>

        <thead>
          <tr><th colspan="3" class="secTitle"></th></tr>
        </thead>

        <tbody>
          <tr>
            <td class="bold">Выгружено ваг.</td>
            <td class="center">
              <input name="{{ bottom.vygr_wag_ktk }}" value="{{ obj|data_val:bottom.vygr_wag_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
            <td class="center">
              <input name="{{ bottom.vygr_tonn }}" value="{{ obj|data_val:bottom.vygr_tonn }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
          </tr>

          <tr>
            <td class="bold">Погружено ваг.</td>
            <td class="center">
              <input name="{{ bottom.pogr_wag_ktk }}" value="{{ obj|data_val:bottom.pogr_wag_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
            <td class="center">
              <input name="{{ bottom.pogr_tonn }}" value="{{ obj|data_val:bottom.pogr_tonn }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
          </tr>

          <tr>
            <td class="danger">Груз на своих осях (ваг)</td>
            <td class="center">
              <input name="{{ bottom.os_wag_ktk }}" value="{{ obj|data_val:bottom.os_wag_ktk }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
            <td class="center">
              <input name="{{ bottom.os_tonn }}" value="{{ obj|data_val:bottom.os_tonn }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
          </tr>

          <!-- ТВОЙ ВАРИАНТ: cargo_name сверху, cargo_volume снизу -->
          <tr>
            <td rowspan="2" class="bold">ПОГРУЖЕНО (наименование груза)</td>
            <td rowspan="2" class="center bold">Объём</td>
            <td class="center">
              <input name="{{ bottom.cargo_name }}" value="{{ obj|data_val:bottom.cargo_name }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
          </tr>
          <tr>
            <td class="center">
              <input name="{{ bottom.cargo_volume }}" value="{{ obj|data_val:bottom.cargo_volume }}" {% if mode == 'view' %}disabled{% endif %}>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- ================= КП ПО СЕКТОРУ ================= -->
      <table class="t2" style="margin-top:10px;">
        <colgroup>
          <col style="width:140px;">
          <col>
          <col>
          <col>
        </colgroup>

        <thead>
          <tr>
            <th colspan="4" class="secTitle">Наличие на КП по сектору</th>
          </tr>
          <tr>
            <th></th>
            <th class="center bold">Вместимость</th>
            <th class="center bold">Факт</th>
            <th class="center bold">Свободно</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td class="center bold">ФП</td>
            <td class="center"><input name="{{ bottom.kp_fp_capacity }}" value="{{ obj|data_val:bottom.kp_fp_capacity }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_fp_fact }}" value="{{ obj|data_val:bottom.kp_fp_fact }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_fp_free }}" value="{{ obj|data_val:bottom.kp_fp_free }}" {% if mode == 'view' %}disabled{% endif %}></td>
          </tr>

          <tr>
            <td class="center bold">УУС</td>
            <td class="center"><input name="{{ bottom.kp_uus_capacity }}" value="{{ obj|data_val:bottom.kp_uus_capacity }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_uus_fact }}" value="{{ obj|data_val:bottom.kp_uus_fact }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_uus_free }}" value="{{ obj|data_val:bottom.kp_uus_free }}" {% if mode == 'view' %}disabled{% endif %}></td>
          </tr>

          <tr>
            <td>Готовые контейнера к отправке</td>
            <td class="center"><input name="{{ bottom.kp_ready_send_capacity }}" value="{{ obj|data_val:bottom.kp_ready_send_capacity }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_ready_send_fact }}" value="{{ obj|data_val:bottom.kp_ready_send_fact }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_ready_send_free }}" value="{{ obj|data_val:bottom.kp_ready_send_free }}" {% if mode == 'view' %}disabled{% endif %}></td>
          </tr>

          <tr>
            <td>Готовые контейнера к вывозу</td>
            <td class="center"><input name="{{ bottom.kp_ready_autocar_capacity }}" value="{{ obj|data_val:bottom.kp_ready_autocar_capacity }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_ready_autocar_fact }}" value="{{ obj|data_val:bottom.kp_ready_autocar_fact }}" {% if mode == 'view' %}disabled{% endif %}></td>
            <td class="center"><input name="{{ bottom.kp_ready_autocar_free }}" value="{{ obj|data_val:bottom.kp_ready_autocar_free }}" {% if mode == 'view' %}disabled{% endif %}></td>
          </tr>
        </tbody>
      </table>

    </div>

    {% if mode != 'view' %}
      <button type="submit" class="btn" style="margin-top:10px;">Сохранить</button>
      <a href="{% url 'station_table_2_list' %}" class="btn" style="text-decoration:none;background:#e5e7eb;color:#111;border:1px solid #cbd5e1;margin-left:8px;">
        ← Назад
      </a>
    {% endif %}
  </form>
</div>
{% endblock %}

    {% if error %}
      <div style="background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px 12px;border-radius:12px;font-weight:800;margin:10px 0;">
    {{ error }}
    </div>
{% endif %}

