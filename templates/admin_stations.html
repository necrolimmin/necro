{% extends "base.html" %}

{% block title %}Filiallar{% endblock %}

{% block content %}
<style>
  /* ===== Page header ===== */
  .page-head{
    display:flex;align-items:flex-end;justify-content:space-between;
    gap:12px;flex-wrap:wrap;margin-bottom:14px;
  }
  .page-title{margin:0;font-size:22px;font-weight:800;letter-spacing:-.01em}
  .page-sub{margin:6px 0 0;color:#64748b;font-size:13px}

  .grid2{
    display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start;
  }
  @media (max-width: 980px){
    .grid2{grid-template-columns:1fr}
  }

  /* ===== Cards ===== */
  .cardx{
    background:rgba(255,255,255,.86);
    border:1px solid rgba(15,23,42,.12);
    border-radius:18px;
    padding:14px;
    box-shadow:0 14px 40px rgba(15,23,42,.08);
    backdrop-filter: blur(10px);
  }
  .cardx h2{margin:0 0 10px;font-size:16px;font-weight:750}
  .muted{color:#64748b;font-size:12.5px;line-height:1.45}
  .alert{
    background:rgba(239,68,68,.10);
    border:1px solid rgba(239,68,68,.28);
    color:#991b1b;
    padding:10px 12px;
    border-radius:14px;
    font-weight:700;
    margin:10px 0 12px;
  }

  /* ===== Form ===== */
  .field{margin:10px 0}
  .field label{display:block;font-weight:600;margin-bottom:6px}
  .inp{
    width:100%;
    height:44px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.16);
    padding:0 12px;
    outline:none;
    background:rgba(248,250,252,.9);
    transition:.15s ease;
    box-sizing:border-box;
  }
  .inp:focus{
    border-color:rgba(37,99,235,.55);
    box-shadow:0 0 0 4px rgba(37,99,235,.12);
    background:#fff;
  }

  .pw-wrap{position:relative}
  .pw-toggle{
    position:absolute;top:50%;right:10px;transform:translateY(-50%);
    width:42px;height:36px;border-radius:12px;
    border:1px solid rgba(15,23,42,.16);
    background:rgba(255,255,255,.9);
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
    transition:.15s ease;
  }
  .pw-toggle:hover{filter:brightness(.98)}
  .pw-toggle svg{width:18px;height:18px}

  .btnx{
    display:inline-flex;align-items:center;justify-content:center;
    height:44px;padding:0 14px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.14);
    background:linear-gradient(135deg, rgba(37,99,235,.95), rgba(16,185,129,.92));
    color:#fff;font-weight:800;text-decoration:none;
    cursor:pointer;
    transition:.15s ease;
    box-shadow:0 12px 24px rgba(37,99,235,.18);
  }
  .btnx:hover{transform:translateY(-1px)}
  .btnx:active{transform:translateY(0)}

  .btn-danger{
    display:inline-flex;align-items:center;justify-content:center;
    height:38px;padding:0 12px;
    border-radius:12px;
    border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.10);
    color:#b91c1c;
    font-weight:800;
    cursor:pointer;
    transition:.15s ease;
  }
  .btn-danger:hover{background:rgba(239,68,68,.16);transform:translateY(-1px)}
  .btn-danger:active{transform:translateY(0)}

  /* ===== Table (desktop) ===== */
  .table-wrap{
    border:1px solid rgba(15,23,42,.12);
    border-radius:16px;
    overflow:hidden;
    background:rgba(255,255,255,.92);
  }
  .scroll-x{overflow:auto}
  .tbl{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:720px;
  }
  .tbl th, .tbl td{
    padding:12px 12px;
    border-bottom:1px solid rgba(15,23,42,.10);
    text-align:left;
    font-size:13px;
    vertical-align:middle;
  }
  .tbl th{
    background:linear-gradient(180deg, rgba(248,250,252,.98), rgba(241,245,249,.85));
    font-weight:750;
    position:sticky;top:0;z-index:1;
  }
  .tbl tr:hover td{background:rgba(2,132,199,.04)}
  .tbl td:last-child{text-align:right}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  .actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}

  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(248,250,252,.9);
    font-weight:700;font-size:12px;
  }

  /* ===== Mobile cards ===== */
  .mobile-list{display:none; gap:12px; flex-direction:column; margin-top:12px;}
  .mcard{
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.92);
    border-radius:16px;
    padding:12px;
  }
  .mhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
  .mname{font-weight:800}
  .mkv{margin-top:10px; display:grid; gap:8px;}
  .mrow{display:flex;justify-content:space-between;gap:12px;font-size:13px;color:#475569}
  .mrow b{color:#0f172a;font-weight:800}
  .mact{margin-top:12px; display:flex; justify-content:flex-start}

  /* ✅ Mobilga o‘tganda jadvalni yashiramiz, cardni chiqaramiz */
  @media (max-width: 680px){
    .table-wrap{display:none;}
    .mobile-list{display:flex;}
  }
</style>
<style>
  .switch{
    position:relative;
    width:46px;
    height:26px;
    display:inline-block;
  }
  .switch input{
    opacity:0;width:0;height:0;
  }
  .slider{
    position:absolute; inset:0;
    background:#e2e8f0;                 /* OFF */
    border:1px solid rgba(15,23,42,.16);
    border-radius:999px;
    transition:.18s ease;
  }
  .slider:before{
    content:"";
    position:absolute;
    width:20px;height:20px;
    left:3px; top:50%;
    transform:translateY(-50%);
    background:#fff;
    border-radius:999px;
    box-shadow:0 6px 12px rgba(15,23,42,.14);
    transition:.18s ease;
  }
  .switch input:checked + .slider{
    background:rgba(34,197,94,.35);     /* ON */
    border-color:rgba(34,197,94,.45);
  }
  .switch input:checked + .slider:before{
    transform:translateY(-50%) translateX(20px);
  }
</style>


<div class="page-head">
  <div>
    <h1 class="page-title" data-i18n="stations_title">Filiallar</h1>
    <div class="page-sub" data-i18n="stations_sub">Filial foydalanuvchilarini yaratish va boshqarish.</div>
  </div>
</div>

<div class="grid2">

  <!-- LEFT -->
  <div class="cardx">
    <h2 data-i18n="create_title">Filial qo‘shish</h2>

    {% if error %}
      <div class="alert">{{ error }}</div>
    {% endif %}

    <form method="post" autocomplete="off">
      {% csrf_token %}

      <div class="field">
        <label data-i18n="label_station">Filial nomi</label>
        <input class="inp" name="station_name" required placeholder="Masalan: necro">
      </div>

      <div class="field">
        <label data-i18n="label_username">Username (login)</label>
        <input class="inp mono" name="username" required placeholder="login">
      </div>

      <div class="field">
        <label data-i18n="label_password">Password</label>
        <div class="pw-wrap">
          <input class="inp mono" id="pw" name="password" type="password" required placeholder="********">
          <button class="pw-toggle" type="button" id="pwBtn" aria-label="Show password">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7Z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
        <div class="muted" style="margin-top:8px" data-i18n="pw_note">
          Eslatma: Django parolni ochiq ko‘rinishda saqlamaydi. Ro‘yxatda parolni ko‘rsatish uchun uni alohida saqlash kerak (xavfsiz emas).
        </div>
      </div>

      <button class="btnx" type="submit">
        <span data-i18n="btn_create">Yaratish</span>
      </button>
    </form>
  </div>

  <!-- RIGHT -->
  <div class="cardx">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap;">
      <div>
        <h2 style="margin:0" data-i18n="list_title">Filiallar ro‘yxati</h2>
        <div class="muted" style="margin-top:6px" data-i18n="list_sub">
          O‘chirishda ehtiyot bo‘ling — foydalanuvchi ham o‘chadi.
        </div>
      </div>
      <div class="pill">
        <span data-i18n="count">Soni</span>: <b class="mono">{{ stations|length }}</b>
      </div>
    </div>

    <!-- Desktop table -->
    <div class="table-wrap" style="margin-top:12px;">
      <div class="scroll-x">
        <table class="tbl">
          <thead>
            <tr>
              <th data-i18n="col_name">Nomi</th>
              <th data-i18n="col_login">Login</th>
              <th data-i18n="col_password">Parol</th>
              <th>status</th>
              <th style="width:160px;text-align:right;" data-i18n="col_actions">Amallar</th>
            </tr>
          </thead>
          <tbody>
            {% for s in stations %}
              <tr>
                <td><b>{{ s.station_name }}</b></td>
                <td class="mono">{{ s.user.username }}</td>
                <td class="mono">{{ s.plain_password|default:"—" }}</td>
                <td>{{s.status}}</td>
                <td>

                  

                  <div class="actions">

                    <!-- ✅ Toggle: bosilganda status=true -->
                    <form method="post" action="{% url 'promote_station' s.id %}" class="js-toggle-form" style="display:inline-block;">
                      {% csrf_token %}
                      <input type="hidden" name="status" value="{% if s.status %}true{% else %}false{% endif %}" class="js-status-val">

                      <label class="switch" title="Status toggle">
                        <input type="checkbox"
                              class="js-toggle-switch"
                              {% if s.status %}checked{% endif %}>
                        <span class="slider"></span>
                      </label>
                    </form>


                    <!-- Delete -->
                    <form method="post"
                          action="{% url 'admin_station_delete' s.id %}"
                          onsubmit="return confirm('Удалить станцию {{ s.station_name }} ({{ s.user.username }})?');">
                      {% csrf_token %}
                      <button class="btn-danger" type="submit" data-i18n="btn_delete">O‘chirish</button>
                    </form>

                  </div>

                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="muted" data-i18n="empty">Hozircha filial yo‘q</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile cards (✅ endi faqat mobilga ko‘rinadi) -->
    <div class="mobile-list">
      {% for s in stations %}
        <div class="mcard">
          <div class="mhead">
            <div class="mname">{{ s.station_name }}</div>
            <div class="pill"><span data-i18n="col_login">Login</span>: <b class="mono">{{ s.user.username }}</b></div>
          </div>

          <div class="mkv">
            <div class="mrow"><span data-i18n="col_name">Nomi</span><b>{{ s.station_name }}</b></div>
            <div class="mrow"><span data-i18n="col_login">Login</span><b class="mono">{{ s.user.username }}</b></div>
            <div class="mrow"><span data-i18n="col_password">Parol</span><b class="mono">{{ s.plain_password|default:"—" }}</b></div>
          </div>

          <div class="mact">
            <form method="post"
                  action="{% url 'admin_station_delete' s.id %}"
                  onsubmit="return confirm('Удалить станцию {{ s.station_name }} ({{ s.user.username }})?');">
              {% csrf_token %}
              <button class="btn-danger" type="submit" data-i18n="btn_delete">O‘chirish</button>
            </form>
          </div>
        </div>
      {% empty %}
        <div class="muted" data-i18n="empty">Hozircha filial yo‘q</div>
      {% endfor %}
    </div>

    <div class="muted" style="margin-top:10px" data-i18n="note2">
      Izoh: “Parol” ustuni “—” bo‘lishi mumkin, chunki Django parolni ochiq ko‘rinishda qaytarmaydi.
    </div>
  </div>

</div>

<script>
  // Password toggle
  (function(){
    const pw = document.getElementById('pw');
    const btn = document.getElementById('pwBtn');
    if(!pw || !btn) return;
    btn.addEventListener('click', () => {
      pw.type = (pw.type === 'password') ? 'text' : 'password';
    });
  })();

  // Page i18n (base'ga tegmasdan real-time ishlashi uchun)
  (function(){
    const dict = {
      uz: {
        stations_title: "Filiallar",
        stations_sub: "Filial foydalanuvchilarini yaratish va boshqarish.",
        create_title: "Filial qo‘shish",
        label_station: "Filial nomi",
        label_username: "Username (login)",
        label_password: "Password",
        pw_note: "Eslatma: Django parolni ochiq ko‘rinishda saqlamaydi. Ro‘yxatda parolni ko‘rsatish uchun uni alohida saqlash kerak (xavfsiz emas).",
        btn_create: "Yaratish",
        list_title: "Filiallar ro‘yxati",
        list_sub: "O‘chirishda ehtiyot bo‘ling — foydalanuvchi ham o‘chadi.",
        count: "Soni",
        col_name: "Nomi",
        col_login: "Login",
        col_password: "Parol",
        col_actions: "Amallar",
        btn_delete: "O‘chirish",
        empty: "Hozircha filial yo‘q",
        note2: "Izoh: “Parol” ustuni “—” bo‘lishi mumkin, chunki Django parolni ochiq ko‘rinishda qaytarmaydi."
      },
      ru: {
        stations_title: "Филиалы",
        stations_sub: "Создание и управление пользователями филиалов (станций).",
        create_title: "Добавить филиал",
        label_station: "Название филиала",
        label_username: "Логин (username)",
        label_password: "Пароль",
        pw_note: "Важно: Django не хранит пароль в открытом виде. Чтобы показывать пароль — нужно хранить отдельно (это небезопасно).",
        btn_create: "Создать",
        list_title: "Список филиалов",
        list_sub: "Будьте осторожны при удалении — пользователь тоже будет удалён.",
        count: "Кол-во",
        col_name: "Название",
        col_login: "Логин",
        col_password: "Пароль",
        col_actions: "Действия",
        btn_delete: "Удалить",
        empty: "Пока нет филиалов",
        note2: "Примечание: колонка “Пароль” может быть “—”, так как Django не возвращает пароль в открытом виде."
      }
    };

    function getLang(){
      const saved = localStorage.getItem('lang') || 'uz';
      return saved === 'ru' ? 'ru' : 'uz';
    }

    function applyLang(lang){
      const t = dict[lang] || dict.uz;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        if(t[k] != null) el.textContent = t[k];
      });
    }

    // initial
    let last = getLang();
    applyLang(last);

    // ✅ base tugmasi bosilganda localStorage o‘zgaradi — biz kuzatib turamiz
    setInterval(()=>{
      const cur = getLang();
      if(cur !== last){
        last = cur;
        applyLang(cur);
      }
    }, 250);
  })();
</script>

<script>
(function(){
  document.querySelectorAll('.js-toggle-form').forEach(form=>{
    const sw = form.querySelector('.js-toggle-switch');
    const hidden = form.querySelector('.js-status-val');
    if(!sw || !hidden) return;

    sw.addEventListener('change', ()=>{
      // checkbox holatiga qarab hidden input qiymatini yangilaymiz
      hidden.value = sw.checked ? 'true' : 'false';

      // formni yuboramiz (POST)
      form.submit();
    });
  });
})();
</script>



{% endblock %}
