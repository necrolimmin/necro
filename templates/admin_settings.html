{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  :root{
    --db-radius: 22px;
    --db-radius-sm: 16px;
    --db-pad: 14px;
    --db-gap: 12px;

    --glass: rgba(255,255,255,.40);
    --glass2: rgba(255,255,255,.22);
    --glass-dark: rgba(255,255,255,.06);

    --ring: rgba(37,99,235,.22);
    --ring2: rgba(16,185,129,.18);

    --shadow2: 0 18px 50px rgba(15,23,42,.10);
    --shadow3: 0 12px 30px rgba(15,23,42,.08);

    --good: rgba(16,185,129,.95);
    --warn: rgba(245,158,11,.95);
    --bad: rgba(239,68,68,.95);
    --info: rgba(59,130,246,.95);
  }
  html[data-theme="dark"]{
    --glass: rgba(255,255,255,.08);
    --glass2: rgba(255,255,255,.05);
    --shadow2: 0 20px 60px rgba(0,0,0,.45);
    --shadow3: 0 14px 40px rgba(0,0,0,.38);
  }

  .dbx{
    max-width: 1320px;
    margin: 0 auto;
    padding: 10px 12px 18px;
    box-sizing: border-box;
  }

  /* ---- header ---- */
  .dbx-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin: 6px 0 12px;
  }
  .dbx-title{
    margin:0;
    font-size:22px;
    font-weight:1000;
    letter-spacing:-.02em;
    color:var(--text);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .dbx-title-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 6px 10px;
    border:1px solid var(--stroke);
    border-radius: 999px;
    background: var(--glass2);
    box-shadow: var(--shadow3);
    font-size:12px;
    font-weight:950;
    color: var(--text);
    white-space:nowrap;
  }
  .dbx-sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.45;
    max-width: 740px;
  }

  /* ---- controls ---- */
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
    justify-content:flex-end;
  }
  .ctrl{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 180px;
  }
  .ctrl label{
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }
  .inpx{
    height: 42px;
    border-radius: 14px;
    border: 1px solid var(--stroke);
    background: var(--glass);
    color: var(--text);
    padding: 0 12px;
    outline: none;
    box-shadow: var(--shadow3);
  }
  .inpx:focus{
    box-shadow: 0 0 0 4px var(--ring), var(--shadow3);
    border-color: rgba(37,99,235,.45);
  }

  .btnx{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    height:42px;
    padding:0 14px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background: var(--glass);
    color: var(--text);
    font-weight: 950;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    box-shadow: var(--shadow3);
    white-space:nowrap;
  }
  .btnx:hover{ transform: translateY(-1px); filter: saturate(1.05); }
  .btnx:active{ transform: translateY(0); }

  .btnx.primary{
    color:#fff;
    border-color: rgba(37,99,235,.35);
    background: linear-gradient(135deg, rgba(37,99,235,.98), rgba(16,185,129,.92));
    box-shadow: 0 18px 40px rgba(37,99,235,.16);
  }
  html[data-theme="dark"] .btnx.primary{
    box-shadow: 0 20px 55px rgba(0,0,0,.45);
  }

  .btnx.ghost{
    background: transparent;
    border-style: dashed;
  }

  /* ---- layout grids ---- */
  .grid-kpi{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: var(--db-gap);
    margin-top: 10px;
    margin-bottom: 12px;
  }
  
  @media (max-width: 1100px){
    .grid-kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (max-width: 600px){
    .grid-kpi{ grid-template-columns: 1fr; }
    .ctrl{ min-width: 100%; }
    .btnx{ width: 100%; }
    .controls{ width:100%; justify-content:stretch; }
  }

  .grid-top{
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap: var(--db-gap);
    margin-bottom: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .grid-top{ grid-template-columns: 1fr; }
  }

  .grid-mid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--db-gap);
    margin-bottom: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .grid-mid{ grid-template-columns: 1fr; }
  }

  .grid-bottom{
    display:grid;
    grid-template-columns: 1fr;
    gap: var(--db-gap);
    align-items: start;
  }

  /* ---- cards ---- */
  .card{
    border-radius: var(--db-radius);
    border: 1px solid var(--stroke);
    background: var(--surface);
    box-shadow: var(--shadow2);
    padding: var(--db-pad);
    overflow: hidden;
    position: relative;
  }
  .card::before{
    content:"";
    position:absolute;
    inset:-2px;
    background:
      radial-gradient(600px 260px at 10% 0%, rgba(37,99,235,.14), transparent 55%),
      radial-gradient(520px 260px at 90% 0%, rgba(16,185,129,.12), transparent 55%);
    pointer-events:none;
  }
  html[data-theme="dark"] .card::before{
    background:
      radial-gradient(600px 260px at 10% 0%, rgba(99,102,241,.18), transparent 55%),
      radial-gradient(520px 260px at 90% 0%, rgba(16,185,129,.10), transparent 55%);
  }

  .card > *{ position: relative; }
  
  .card-h{
    display:flex;
    align-items:flex-start;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .card-title{
    margin:0;
    font-size: 14px;
    font-weight: 1000;
    letter-spacing:-.01em;
    color: var(--text);
  }
  .card-sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.35;
  }

  /* ---- kpi card ---- */
  .kpi{
    display:flex;
    justify-content:space-between;
    gap: 10px;
    align-items:flex-start;
    min-height: 88px;
  }
  .kpi-left .val{
    font-size: 26px;
    font-weight: 1100;
    letter-spacing:-.02em;
    color: var(--text);
    margin-top: 8px;
  }
  .kpi-left .meta{
    margin-top: 6px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.3;
  }

  .kpi-icon{
    width: 54px;
    height: 54px;
    border-radius: 18px;
    border: 1px solid var(--stroke);
    background: var(--glass2);
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: var(--shadow3);
    font-size: 24px;
  }

  .kpi-icon svg{
  transition: transform .25s ease;
  }
  .card-3d:hover .kpi-icon svg{
    transform: translateY(1px) scale(1.06);
  }

  .chip{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--stroke);
    background: var(--glass2);
    font-size: 12px;
    font-weight: 950;
    color: var(--text);
    white-space: nowrap;
  }
  .dot{ width:8px; height:8px; border-radius: 999px; background: var(--good); }
  .dot.warn{ background: var(--warn); }
  .dot.bad{ background: var(--bad); }
  .dot.info{ background: var(--info); }

  /* ---- charts ---- */
  .chart{
    height: 340px;
    width: 100%;
    position: relative;
  }
  @media (max-width: 600px){
    .chart{ height: 280px; }
  }
  .chart.sm{ max-height: 315px; }

  /* ---- income entry panel ---- */
  .income-wrap{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .income-wrap{ grid-template-columns: 1fr; }
  }

  .form-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 560px){
    .form-grid{ grid-template-columns: 1fr; }
  }
  .form-row{
    display:flex;
    flex-direction: column;
    gap: 6px;
  }
  .form-row label{
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }
  .help{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }

  /* ---- table ---- */
  .table-wrap{
    border:1px solid var(--stroke);
    border-radius: var(--db-radius-sm);
    overflow:hidden;
    background: var(--glass2);
  }
  .scroll-x{ overflow:auto; }
  .scroll-x::-webkit-scrollbar{ height:10px; }
  .scroll-x::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.18); border-radius:999px; }
  html[data-theme="dark"] .scroll-x::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); }

  .tbl{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 820px;
  }
  .tbl th, .tbl td{
    padding: 10px 10px;
    border-bottom: 1px solid var(--stroke);
    text-align:left;
    font-size: 12.8px;
    color: var(--text);
  }
  .tbl th{
    font-weight: 1000;
    position: sticky;
    top:0;
    z-index:1;
    background: rgba(255,255,255,.55);
  }
  html[data-theme="dark"] .tbl th{ background: rgba(255,255,255,.06); }

  .tbl tr:hover td{ background: rgba(2,132,199,.06); }
  html[data-theme="dark"] .tbl tr:hover td{ background: rgba(99,102,241,.10); }

  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
  .right{ text-align:right; }

  /* small footer note */
  .note{
    margin-top:10px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.35;
  }

  .income-wrap.onecol{
  display:block;
  }
  .income-wrap.onecol .chart{
    width:100%;
  }

  .chart{
    border-radius: 18px;
    overflow:hidden;
  }
  .chart canvas{
    filter: drop-shadow(0 18px 35px rgba(15,23,42,.18));
  }
  html[data-theme="dark"] .chart canvas{
    filter: drop-shadow(0 22px 45px rgba(0,0,0,.55));
  }

  /* trading panel (dark) */
  .chart-trade{
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.10);
    /* background: linear-gradient(180deg, rgba(2,6,23,.96), rgba(15,23,42,.92)); */
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.06),
      0 22px 60px rgba(0,0,0,.25);
    padding: 10px;
  }
</style>

<div class="dbx">

  <!-- ================= HEADER ================= -->
  <div class="dbx-head">
    <div>
      <h1 class="dbx-title">
        <span>ðŸ“Š</span>
        <span>Operativ Dashboard</span>
        <span class="dbx-title-badge"><span class="dot info"></span><span class="mono" id="rangeBadge">â€”</span></span>
      </h1>
      <div class="dbx-sub">
        Ortish/Tushirish, daromadlar dinamikasi, Logistika sentrlari kesimidagi umumiy koâ€˜rsatkichlar.
        
      </div>
    </div>

    <div class="controls">
      <div class="ctrl">
        <label>Dan</label>
        <input id="dateFrom" class="inpx" type="date">
      </div>
      <div class="ctrl">
        <label>Gacha</label>
        <input id="dateTo" class="inpx" type="date">
      </div>
      <button id="btnApply" class="btnx primary" type="button">
        <span>âœ…</span><span>Apply</span>
      </button>
      
    </div>
  </div>

  <!-- ================= KPI CARDS (like your 2nd image but modern) ================= -->
  <div class="grid-kpi">

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Ortish / Pogruzka</div>
          <div class="val mono" id="kpiOrtish">33 415</div>
          <div class="meta">Vagon </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot"></span><span>ok</span></div>
          <div class="kpi-icon">ðŸš‚</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Tushirish / Vigruzka</div>
          <div class="val mono" id="kpiTushirish">27 794</div>
          <div class="meta">Vagon </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot "></span><span>ok</span></div>
          <div class="kpi-icon">ðŸ“¦</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Ortishda / Podpogruzka</div>
          <div class="val mono" id="kpiPodpogruzka">15 245</div>
          <div class="meta">Vagon</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot warn"></span><span> load</span></div>
          <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">

              <!-- container body -->
              <rect x="3" y="8" width="18" height="10" rx="2" fill="#3B82F6"/>

              <!-- container ribs -->
              <path d="M7 8V18M11 8V18M15 8V18M19 8V18"
                    stroke="rgba(255,255,255,.65)" stroke-width="1"/>

              <!-- upload arrow (UP) -->
              <path d="M12 20V13" stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round"/>
              <path d="M9.5 15.5L12 13L14.5 15.5"
                    stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Tushirishda / Podvigruzka</div>
          <div class="val mono" id="kpiPodvigruzka">10 321 </div>
          <div class="meta">Vagon</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot warn"></span><span>load</span></div>
          <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">

              <!-- wagon -->
              <rect x="3" y="8" width="18" height="7" rx="2"
                    fill="#3B82F6"/>

              <!-- wheels -->
              <circle cx="7" cy="18" r="1.6" fill="#111827"/>
              <circle cx="17" cy="18" r="1.6" fill="#111827"/>

              <!-- unloading arrow down -->
              <path d="M12 3V10" stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round"/>
              <path d="M9.5 7.5L12 10L14.5 7.5"
                    stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round" stroke-linejoin="round"/>

            </svg>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= TOP SECTION ================= -->
  <div class="grid-top">

    <!-- (1) Income entry + mini "trading-like" chart -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Daromad tahlili</h3>
          <div class="card-sub">
            Korxonaning sanalar kesimida daromad tahlili
          </div>
        </div>
        <div class="chip"><span class="dot info"></span><span class="mono">Daromad burchagi</span></div>
      </div>

      <div class="income-wrap onecol">
        <div class="chart sm chart-trade">
          <canvas id="chIncomeMini"></canvas>
        </div>

        <div class="note">
          Hozircha demo: Backend ulangani yoâ€˜q.
        </div>
      </div>
    </div>

    <!-- (4) Structure bar chart (like your 4th image) -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Daromad - filiallar kesimida</h3>
          <div class="card-sub">so'm hisobida olingan</div>
        </div>
        <div class="chip"><span class="dot warn"></span><span class="mono">Daromad</span></div>
      </div>
      <div class="chart">
        <canvas id="chStructure"></canvas>
      </div>
    </div>

    

  </div>

  <!-- ================= MID SECTION ================= -->
  <div class="grid-mid">

    <!-- (3) Monthly line chart (like your 3rd image) -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Oylar boâ€˜yicha umumiy dinamika</h3>
          <div class="card-sub">Ortish (yashil) va Tushirish (qizil) </div>
        </div>
        <div class="chip"><span class="dot info"></span><span class="mono">Monthly</span></div>
      </div>
      <div class="chart">
        <canvas id="chMonthly"></canvas>
      </div>
    </div>

    <!-- (2) Day/Night (Top-5) -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Tushirishda va Ortishda </h3>
          <div class="card-sub">Tanlangan oraliq boâ€˜yicha ortishda/tushirishda ma'lumotlarining filiallari kesimida tahlili </div>
        </div>
        <div class="chip"><span class="dot"></span><span class="mono">Stacked</span></div>
      </div>
      <div class="chart">
        <canvas id="chDayNight"></canvas>
      </div>
    </div>

  </div>

  <!-- ================= BOTTOM SECTION ================= -->
  <div class="grid-bottom">

    <!-- (5) Stations wide chart (like your 5th image) -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Filiallar kesimida Ortish va Tushirish umumiy grafik</h3>
          <div class="card-sub"> Ortish (koâ€˜k), Tushirish (pushti) </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div class="chip"><span class="dot info"></span><span class="mono">Stations</span></div>
          <button id="btnSortStations" class="btnx" type="button"><span>â‡…</span><span>Sort</span></button>
        </div>
      </div>
      <div class="chart" style="height: 560px;">
        <canvas id="chStations"></canvas>
      </div>
    </div>

    <!-- recent activity table (extra modern add-on) -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Oxirgi faoliyat (demo)</h3>
          <div class="card-sub">Buni ustida ishlaymiz</div>
        </div>
        <a class="btnx" href="{% url 'admin_table1_reports' %}">
          <span>ðŸ”Ž</span><span>Admin</span>
        </a>
      </div>

      <div class="table-wrap">
        <div class="scroll-x">
          <table class="tbl" id="recentTable">
            <thead>
              <tr>
                <th>Sana</th>
                <th>Stansiya</th>
                <th>Tur</th>
                <th class="right">Summa</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS will fill demo rows -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- ================= DATA HOOKS =================

-->
{{ dash_json|json_script:"dash-json" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  (function(){
    // ============================================================
    // 0) Read server-provided JSON
    // ============================================================
    const raw = document.getElementById("dash-json");
    let DASH = {};
    try { DASH = JSON.parse(raw?.textContent || "{}"); } catch(e){ DASH = {}; }

    // ============================================================
    // 1) DEMO fallback (works even if backend missing)
    // ============================================================
    const DEMO = {
      range: { from: null, to: null },

      kpi: {
        ortish_vagon: 33415,
        tushirish_vagon: 27794,
        podpogruzka_vagon: 8520,
        podvigruzka_vagon: 6140
      },

      // trader-like daily line
      incomeMini: {
        labels: ["10.02.25","11.02.25","12.02.25","13.02.25","14.02.25","15.02.25","16.02.25","17.02.25","18.02.25","19.02.25","20.02.25"],
        values: [44100,44500,44300,44800,44650,45100,44920,45800,45600,45448,45520]
      },

      dayNightTop: {
        labels: ["Angren","Sergeli","Toshkent","Chuqursoy","Boytog"],
        day:   [22000,18000,17000,15000,12000],
        night: [26000,15000,38000,52000,24000]
      },

      monthly: {
        labels: ["August","September","October","November","December","January","February"],
        ortish:    [12000,54000,55000,51000,59000,60000,33415],
        tushirish: [ 9000,35000,40000,34000,40000,44000,27794]
      },

      structure: {
        labels: ["Angren","Sergeli","Chuqursoy","Toshkent","Tuy-tepa","Qarshi"],
        values: [1600000, 880000, 334150, 277940, 1100000, 120980]
      },

      stations: {
        labels: ["Angren","Bekobod","Boytog","Chuqursoy","Keles","Obliq","O'zodlik","Sergeli","Toshkent","Uzbekiston"],
        ortish: [104333, 18254, 35551, 31123,  4001, 19059, 37546, 34406, 17249,  8017],
        tushirish:[26481, 25021, 11992, 52600,  5175, 15824, 34526, 51953, 38671, 13841]
      },

      recent: [
        {date:"2026-02-20", station:"Toshkent", type:"Income", amount: 125000000, status:"OK"},
        {date:"2026-02-20", station:"Angren", type:"Ortish", amount: 2200, status:"OK"},
        {date:"2026-02-19", station:"Sergeli", type:"Tushirish", amount: 1900, status:"Warning"},
        {date:"2026-02-19", station:"Chuqursoy", type:"Income", amount: 98000000, status:"OK"},
        {date:"2026-02-18", station:"Bekobod", type:"Income", amount: 64000000, status:"Attention"}
      ]
    };

    // ============================================================
    // 2) Deep merge: DEMO is base, server overrides
    // ============================================================
    function deepMerge(base, extra){
      if(!extra || typeof extra !== "object") return base;
      const out = Array.isArray(base) ? [...base] : {...base};
      for(const k of Object.keys(extra)){
        const bv = base?.[k];
        const ev = extra[k];
        if(ev && typeof ev === "object" && !Array.isArray(ev)){
          out[k] = deepMerge(bv || {}, ev);
        } else {
          out[k] = ev;
        }
      }
      return out;
    }
    const D = deepMerge(DEMO, DASH);

    // ============================================================
    // 3) Helpers
    // ============================================================
    const spaced = (n)=> (n ?? 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    const money = (n)=> (n ?? 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");

    const isDark = ()=> document.documentElement.getAttribute("data-theme")==="dark";

    function gridColor(){
      return isDark() ? "rgba(255,255,255,.10)" : "rgba(15,23,42,.10)";
    }

    // ============================================================
    // 4) Date range UI
    // ============================================================
    const $from = document.getElementById("dateFrom");
    const $to = document.getElementById("dateTo");
    const $badge = document.getElementById("rangeBadge");
    const iso = (x)=> x.toISOString().slice(0,10);

    function fmtRange(a,b){
      if(!a && !b) return "All time";
      if(a && !b) return a + " â†’ â€¦";
      if(!a && b) return "â€¦ â†’ " + b;
      return a + " â†’ " + b;
    }

    if($from && $to && $badge){
      const today = new Date();
      const dTo = new Date(today);
      const dFrom = new Date(today); dFrom.setDate(dFrom.getDate() - 30);

      $from.value = D.range?.from || iso(dFrom);
      $to.value = D.range?.to || iso(dTo);
      $badge.textContent = fmtRange($from.value, $to.value);

      const btnApply = document.getElementById("btnApply");
      btnApply?.addEventListener("click", ()=>{
        $badge.textContent = fmtRange($from.value, $to.value);
        // Backend ulaganda: fetch('/api/dashboard?from='+$from.value+'&to='+$to.value)
      });
    }

    // ============================================================
    // 5) KPI fill (4 vagon)
    // ============================================================
    const kpi = D.kpi || {};
    const elOrt = document.getElementById("kpiOrtish");
    const elTush = document.getElementById("kpiTushirish");
    const elPodOrt = document.getElementById("kpiPodpogruzka");
    const elPodTush = document.getElementById("kpiPodvigruzka");

    if(elOrt) elOrt.textContent = spaced(kpi.ortish_vagon);
    if(elTush) elTush.textContent = spaced(kpi.tushirish_vagon);
    if(elPodOrt) elPodOrt.textContent = spaced(kpi.podpogruzka_vagon);
    if(elPodTush) elPodTush.textContent = spaced(kpi.podvigruzka_vagon);

    // ============================================================
    // 6) Chart.js defaults + 3D shadow plugin
    // ============================================================
    if(typeof Chart === "undefined"){
      console.error("Chart.js not loaded");
      return;
    }

    Chart.defaults.font.family =
      'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
    Chart.defaults.color =
      getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#111827';

    const shadowPlugin = {
      id: "shadowPlugin",
      beforeDatasetsDraw(chart, args, opts) {
        const { ctx } = chart;
        ctx.save();
        ctx.shadowColor = opts?.shadowColor || (isDark() ? "rgba(0,0,0,.60)" : "rgba(15,23,42,.18)");
        ctx.shadowBlur  = opts?.shadowBlur ?? 18;
        ctx.shadowOffsetX = opts?.shadowOffsetX ?? 0;
        ctx.shadowOffsetY = opts?.shadowOffsetY ?? 10;
      },
      afterDatasetsDraw(chart) {
        chart.ctx.restore();
      }
    };
    Chart.register(shadowPlugin);

    function safeChart(make){
      try { return make(); }
      catch(e){ console.error("Chart error:", e); return null; }
    }

    // ============================================================
    // 7) (A) Trader income chart: green up / red down segments
    // ============================================================
    const upColor = "rgba(34,197,94,0.98)";
    const downColor = "rgba(239,68,68,0.98)";

    const chIncomeMini = safeChart(()=> new Chart(document.getElementById("chIncomeMini"), {
      type: "line",
      data: {
        labels: D.incomeMini.labels,
        datasets: [{
          label: "Daromad",
          data: D.incomeMini.values,
          tension: 0.22,
          pointRadius: 0,
          borderWidth: 2,
          segment: {
            borderColor: (ctx) => {
              const y0 = ctx.p0.parsed.y;
              const y1 = ctx.p1.parsed.y;
              return (y1 >= y0) ? upColor : downColor;
            },
          },
          fill: true,
          backgroundColor: "rgba(56,189,248,0.10)"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          shadowPlugin: { shadowBlur: 22, shadowOffsetY: 10 },
          legend: { display: false },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          x: {
            grid: { color: isDark() ? "rgba(255,255,255,.06)" : "rgba(15,23,42,.06)" }
          },
          y: {
            grid: { color: isDark() ? "rgba(255,255,255,.08)" : "rgba(15,23,42,.08)" },
            ticks: { precision: 0 }
          }
        }
      }
    }));

    // ============================================================
    // 8) (B) Day/Night stacked bar (modern rounded)
    // ============================================================
    const chDayNight = safeChart(()=> new Chart(document.getElementById("chDayNight"), {
      type: "bar",
      data: {
        labels: D.dayNightTop.labels,
        datasets: [
          {
            label: "Podpogruzka",
            data: D.dayNightTop.day,
            stack: "s",
            borderWidth: 0,
            borderRadius: 12,
            barThickness: 18,
            maxBarThickness: 22
          },
          {
            label: "Podvigruzka",
            data: D.dayNightTop.night,
            stack: "s",
            borderWidth: 0,
            borderRadius: 12,
            barThickness: 18,
            maxBarThickness: 22
          }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: {
          shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 },
          legend: { position: "bottom" }
        },
        scales: {
          x: { stacked:true, grid: { display:false } },
          y: { stacked:true, beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));

    // ============================================================
    // 9) (C) Monthly line chart (modern + shadow)
    // ============================================================
    const chMonthly = safeChart(()=> new Chart(document.getElementById("chMonthly"), {
      type: "line",
      data: {
        labels: D.monthly.labels,
        datasets: [
          {
            label: "Ortish",
            data: D.monthly.ortish,
            tension: 0.30,
            borderWidth: 2,
            pointRadius: 3,
            fill: false
          },
          {
            label: "Tushirish",
            data: D.monthly.tushirish,
            tension: 0.30,
            borderWidth: 2,
            pointRadius: 3,
            fill: false
          }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: {
          shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 },
          legend: { position: "top" }
        },
        scales: {
          x: { grid: { display:false } },
          y: { beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));

    // ============================================================
    // 10) (D) Structure bar (modern rounded)
    // ============================================================
    const chStructure = safeChart(()=> new Chart(document.getElementById("chStructure"), {
      type: "bar",
      data: {
        labels: D.structure.labels,
        datasets: [{
          label: "Daromad",
          data: D.structure.values,
          borderWidth: 0,
          borderRadius: 12,
          barThickness: 18,
          maxBarThickness: 22
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: {
          shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 },
          legend: { position: "top" }
        },
        scales: {
          x: { grid: { display:false } },
          y: { beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));

    // ============================================================
    // 11) (E) Stations horizontal stacked + sort
    // ============================================================
    let stationsSorted = false;
    let chStations = null;

    function buildStationsData(sorted){
      const labels = [...D.stations.labels];
      const ort = [...D.stations.ortish];
      const tus = [...D.stations.tushirish];

      if(sorted){
        const idx = labels.map((_,i)=>i)
          .sort((a,b)=> (ort[b]+tus[b]) - (ort[a]+tus[a]));
        return {
          labels: idx.map(i=>labels[i]),
          ortish: idx.map(i=>ort[i]),
          tushirish: idx.map(i=>tus[i]),
        };
      }
      return { labels, ortish: ort, tushirish: tus };
    }

    function renderStations(sorted){
      const X = buildStationsData(sorted);
      if(chStations) chStations.destroy();

      chStations = safeChart(()=> new Chart(document.getElementById("chStations"), {
        type: "bar",
        data: {
          labels: X.labels,
          datasets: [
            {
              label: "Ortish",
              data: X.ortish,
              stack:"s",
              borderWidth:0,
              borderRadius: 12,
              barThickness: 16,
              maxBarThickness: 20
            },
            {
              label: "Tushirish",
              data: X.tushirish,
              stack:"s",
              borderWidth:0,
              borderRadius: 12,
              barThickness: 16,
              maxBarThickness: 20
            }
          ]
        },
        options: {
          indexAxis: "y",
          responsive:true,
          maintainAspectRatio:false,
          plugins: {
            shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 },
            legend: { position: "top" }
          },
          scales: {
            x: { stacked:true, grid: { color: gridColor() }, ticks: { precision:0 } },
            y: { stacked:true, grid: { display:false } }
          }
        }
      }));
    }

    renderStations(false);

    document.getElementById("btnSortStations")?.addEventListener("click", ()=>{
      stationsSorted = !stationsSorted;
      renderStations(stationsSorted);
    });

    // ============================================================
    // 12) Recent table fill
    // ============================================================
    const tbody = document.querySelector("#recentTable tbody");
    if(tbody){
      const badge = (s)=>{
        if(s==="OK") return '<span class="chip"><span class="dot"></span><span>OK</span></span>';
        if(s==="Warning") return '<span class="chip"><span class="dot warn"></span><span>Warning</span></span>';
        return '<span class="chip"><span class="dot bad"></span><span>Attention</span></span>';
      };

      tbody.innerHTML = (D.recent || []).map(r=>`
        <tr>
          <td class="mono">${r.date}</td>
          <td><b>${r.station}</b></td>
          <td class="mono">${r.type}</td>
          <td class="right mono">${money(r.amount)}</td>
          <td>${badge(r.status)}</td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="mono" style="color:var(--muted)">Ma'lumot yoâ€˜q</td></tr>`;
    }

  })();
</script>
{% endblock %}