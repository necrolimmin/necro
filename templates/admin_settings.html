{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  :root{
    --db-radius: 22px;
    --db-radius-sm: 16px;
    --db-pad: 14px;
    --db-gap: 12px;

    --glass: rgba(255,255,255,.40);
    --glass2: rgba(255,255,255,.22);
    --glass-dark: rgba(255,255,255,.06);

    --ring: rgba(37,99,235,.22);
    --ring2: rgba(16,185,129,.18);

    --shadow2: 0 18px 50px rgba(15,23,42,.10);
    --shadow3: 0 12px 30px rgba(15,23,42,.08);

    --good: rgba(16,185,129,.95);
    --warn: rgba(245,158,11,.95);
    --bad: rgba(239,68,68,.95);
    --info: rgba(59,130,246,.95);
  }
  html[data-theme="dark"]{
    --glass: rgba(255,255,255,.08);
    --glass2: rgba(255,255,255,.05);
    --shadow2: 0 20px 60px rgba(0,0,0,.45);
    --shadow3: 0 14px 40px rgba(0,0,0,.38);
  }

  .dbx{
    max-width: 1320px;
    margin: 0 auto;
    padding: 10px 12px 18px;
    box-sizing: border-box;
  }

  /* ---- header ---- */
  .dbx-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin: 6px 0 12px;
  }
  .dbx-title{
    margin:0;
    font-size:22px;
    font-weight:1000;
    letter-spacing:-.02em;
    color:var(--text);
    display:flex;
    align-items:center;
    gap:10px;
  }
  .dbx-title-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 6px 10px;
    border:1px solid var(--stroke);
    border-radius: 999px;
    background: var(--glass2);
    box-shadow: var(--shadow3);
    font-size:12px;
    font-weight:950;
    color: var(--text);
    white-space:nowrap;
  }
  .dbx-sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.45;
    max-width: 740px;
  }

  /* ---- controls ---- */
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
    justify-content:flex-end;
  }
  .ctrl{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 180px;
  }
  .ctrl label{
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }
  .inpx{
    height: 42px;
    border-radius: 14px;
    border: 1px solid var(--stroke);
    background: var(--glass);
    color: var(--text);
    padding: 0 12px;
    outline: none;
    box-shadow: var(--shadow3);
  }
  .inpx:focus{
    box-shadow: 0 0 0 4px var(--ring), var(--shadow3);
    border-color: rgba(37,99,235,.45);
  }

  .btnx{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    height:42px;
    padding:0 14px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background: var(--glass);
    color: var(--text);
    font-weight: 950;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    box-shadow: var(--shadow3);
    white-space:nowrap;
  }
  .btnx:hover{ transform: translateY(-1px); filter: saturate(1.05); }
  .btnx:active{ transform: translateY(0); }

  .btnx.primary{
    color:#fff;
    border-color: rgba(37,99,235,.35);
    background: linear-gradient(135deg, rgba(37,99,235,.98), rgba(16,185,129,.92));
    box-shadow: 0 18px 40px rgba(37,99,235,.16);
  }
  html[data-theme="dark"] .btnx.primary{
    box-shadow: 0 20px 55px rgba(0,0,0,.45);
  }

  .btnx.ghost{
    background: transparent;
    border-style: dashed;
  }

  /* ---- layout grids ---- */
  .grid-kpi{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: var(--db-gap);
    margin-top: 10px;
    margin-bottom: 12px;
  }
  
  @media (max-width: 1100px){
    .grid-kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (max-width: 600px){
    .grid-kpi{ grid-template-columns: 1fr; }
    .ctrl{ min-width: 100%; }
    .btnx{ width: 100%; }
    .controls{ width:100%; justify-content:stretch; }
  }

  .grid-top{
    display:grid;
    grid-template-columns: 1.15fr .85fr;
    gap: var(--db-gap);
    margin-bottom: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .grid-top{ grid-template-columns: 1fr; }
  }

  .grid-mid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--db-gap);
    margin-bottom: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .grid-mid{ grid-template-columns: 1fr; }
  }

  .grid-bottom{
    display:grid;
    grid-template-columns: 1fr;
    gap: var(--db-gap);
    align-items: start;
  }

  /* ---- cards ---- */
  .card{
    border-radius: var(--db-radius);
    border: 1px solid var(--stroke);
    background: var(--surface);
    box-shadow: var(--shadow2);
    padding: var(--db-pad);
    overflow: hidden;
    position: relative;
  }
  .card::before{
    content:"";
    position:absolute;
    inset:-2px;
    background:
      radial-gradient(600px 260px at 10% 0%, rgba(37,99,235,.14), transparent 55%),
      radial-gradient(520px 260px at 90% 0%, rgba(16,185,129,.12), transparent 55%);
    pointer-events:none;
  }
  html[data-theme="dark"] .card::before{
    background:
      radial-gradient(600px 260px at 10% 0%, rgba(99,102,241,.18), transparent 55%),
      radial-gradient(520px 260px at 90% 0%, rgba(16,185,129,.10), transparent 55%);
  }

  .card > *{ position: relative; }
  
  .card-h{
    display:flex;
    align-items:flex-start;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .card-title{
    margin:0;
    font-size: 14px;
    font-weight: 1000;
    letter-spacing:-.01em;
    color: var(--text);
  }
  .card-sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.35;
  }

  /* ---- kpi card ---- */
  .kpi{
    display:flex;
    justify-content:space-between;
    gap: 10px;
    align-items:flex-start;
    min-height: 88px;
  }
  .kpi-left .val{
    font-size: 26px;
    font-weight: 1100;
    letter-spacing:-.02em;
    color: var(--text);
    margin-top: 8px;
  }
  .kpi-left .meta{
    margin-top: 6px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.3;
  }

  .kpi-icon{
    width: 54px;
    height: 54px;
    border-radius: 18px;
    border: 1px solid var(--stroke);
    background: var(--glass2);
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow: var(--shadow3);
    font-size: 24px;
  }

  .kpi-icon svg{
    transition: transform .25s ease;
  }
  .card-3d:hover .kpi-icon svg{
    transform: translateY(1px) scale(1.06);
  }

  .chip{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--stroke);
    background: var(--glass2);
    font-size: 12px;
    font-weight: 950;
    color: var(--text);
    white-space: nowrap;
  }
  .dot{ width:8px; height:8px; border-radius: 999px; background: var(--good); }
  .dot.warn{ background: var(--warn); }
  .dot.bad{ background: var(--bad); }
  .dot.info{ background: var(--info); }

  /* ---- charts ---- */
  .chart{
    height: 340px;
    width: 100%;
    position: relative;
  }
  @media (max-width: 600px){
    .chart{ height: 280px; }
  }
  .chart.sm{ max-height: 315px; }

  /* ---- income entry panel ---- */
  .income-wrap{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap: 12px;
    align-items: start;
  }
  @media (max-width: 980px){
    .income-wrap{ grid-template-columns: 1fr; }
  }

  .form-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 560px){
    .form-grid{ grid-template-columns: 1fr; }
  }
  .form-row{
    display:flex;
    flex-direction: column;
    gap: 6px;
  }
  .form-row label{
    font-size: 12px;
    font-weight: 900;
    color: var(--muted);
  }
  .help{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.35;
  }

  /* ---- table ---- */
  .table-wrap{
    border:1px solid var(--stroke);
    border-radius: var(--db-radius-sm);
    overflow:hidden;
    background: var(--glass2);
  }
  .scroll-x{ overflow:auto; }
  .scroll-x::-webkit-scrollbar{ height:10px; }
  .scroll-x::-webkit-scrollbar-thumb{ background: rgba(15,23,42,.18); border-radius:999px; }
  html[data-theme="dark"] .scroll-x::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); }

  .tbl{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 820px;
  }
  .tbl th, .tbl td{
    padding: 10px 10px;
    border-bottom: 1px solid var(--stroke);
    text-align:left;
    font-size: 12.8px;
    color: var(--text);
  }
  .tbl th{
    font-weight: 1000;
    position: sticky;
    top:0;
    z-index:1;
    background: rgba(255,255,255,.55);
  }
  html[data-theme="dark"] .tbl th{ background: rgba(255,255,255,.06); }

  .tbl tr:hover td{ background: rgba(2,132,199,.06); }
  html[data-theme="dark"] .tbl tr:hover td{ background: rgba(99,102,241,.10); }

  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
  .right{ text-align:right; }

  /* small footer note */
  .note{
    margin-top:10px;
    color: var(--muted);
    font-size: 12.5px;
    line-height: 1.35;
  }

  .income-wrap.onecol{
    display:block;
  }
  .income-wrap.onecol .chart{
    width:100%;
  }

  .chart{
    border-radius: 18px;
    overflow:hidden;
  }
  .chart canvas{
    filter: drop-shadow(0 18px 35px rgba(15,23,42,.18));
  }
  html[data-theme="dark"] .chart canvas{
    filter: drop-shadow(0 22px 45px rgba(0,0,0,.55));
  }

  /* trading panel (dark) */
  .chart-trade{
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,.10);
    /* background: linear-gradient(180deg, rgba(2,6,23,.96), rgba(15,23,42,.92)); */
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.06),
      0 22px 60px rgba(0,0,0,.25);
    padding: 10px;
  }
</style>

<div class="dbx">

  <!-- ================= HEADER ================= -->
  <div class="dbx-head">
    <div>
      <h1 class="dbx-title">
        <span>ðŸ“Š</span>
        <span>Operativ Dashboard</span>
        <span class="dbx-title-badge"><span class="dot info"></span><span class="mono" id="rangeBadge">â€”</span></span>
      </h1>
      <div class="dbx-sub">
        Ortish/Tushirish, daromadlar dinamikasi, Logistika sentrlari kesimidagi umumiy koâ€˜rsatkichlar.
      </div>
    </div>

    <form class="controls" method="get">
  <div class="ctrl">
    <label>Dan</label>
    <input id="dateFrom" name="from" class="inpx" type="date" value="{{ from|default:'' }}">
  </div>

  <div class="ctrl">
    <label>Gacha</label>
    <input id="dateTo" name="to" class="inpx" type="date" value="{{ to|default:'' }}">
  </div>

  <button class="btnx primary" type="submit">
    <span>âœ…</span><span>Apply</span>
  </button>
</form>
  </div>

  <!-- ================= KPI CARDS ================= -->
  <div class="grid-kpi">

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Ortish / Pogruzka</div>
          <div class="val mono" id="kpiOrtish">33 415</div>
          <div class="meta">Vagon </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot"></span><span>ok</span></div>
          <div class="kpi-icon">ðŸš‚</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Tushirish / Vigruzka</div>
          <div class="val mono" id="kpiTushirish">27 794</div>
          <div class="meta">Vagon </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot "></span><span>ok</span></div>
          <div class="kpi-icon">ðŸ“¦</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Ortishda / Podpogruzka</div>
          <div class="val mono" id="kpiPodpogruzka">15 245</div>
          <div class="meta">Vagon</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot warn"></span><span> load</span></div>
          <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="8" width="18" height="10" rx="2" fill="#3B82F6"/>
              <path d="M7 8V18M11 8V18M15 8V18M19 8V18"
                    stroke="rgba(255,255,255,.65)" stroke-width="1"/>
              <path d="M12 20V13" stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round"/>
              <path d="M9.5 15.5L12 13L14.5 15.5"
                    stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="kpi-left">
          <div class="card-title">Tushirishda / Podvigruzka</div>
          <div class="val mono" id="kpiPodvigruzka">10 321 </div>
          <div class="meta">Vagon</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="chip"><span class="dot warn"></span><span>load</span></div>
          <div class="kpi-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="8" width="18" height="7" rx="2"
                    fill="#3B82F6"/>
              <circle cx="7" cy="18" r="1.6" fill="#111827"/>
              <circle cx="17" cy="18" r="1.6" fill="#111827"/>
              <path d="M12 3V10" stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round"/>
              <path d="M9.5 7.5L12 10L14.5 7.5"
                    stroke="#16A34A" stroke-width="2.2"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= TOP SECTION ================= -->
  <div class="grid-top">

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Daromad tahlili</h3>
          <div class="card-sub">
            Korxonaning sanalar kesimida daromad tahlili
          </div>
        </div>
        <div class="chip"><span class="dot info"></span><span class="mono">Daromad burchagi</span></div>
      </div>

      <div class="income-wrap onecol">
        <div class="chart sm chart-trade">
          <canvas id="chIncomeMini"></canvas>
        </div>

        <div class="note">
           
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Daromad - filiallar kesimida</h3>
          <div class="card-sub">so'm hisobida olingan</div>
        </div>
        <div class="chip"><span class="dot warn"></span><span class="mono">Daromad</span></div>
      </div>
      <div class="chart">
        <canvas id="chStructure"></canvas>
      </div>
    </div>

  </div>

  <!-- ================= MID SECTION ================= -->
  <div class="grid-mid">

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Oylar boâ€˜yicha umumiy dinamika</h3>
          <div class="card-sub">Ortish (yashil) va Tushirish (qizil) </div>
        </div>
        <div class="chip"><span class="dot info"></span><span class="mono">Monthly</span></div>
      </div>
      <div class="chart">
        <canvas id="chMonthly"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Tushirishda va Ortishda </h3>
          <div class="card-sub">Tanlangan oraliq boâ€˜yicha ortishda/tushirishda ma'lumotlarining filiallari kesimida tahlili </div>
        </div>
        <div class="chip"><span class="dot"></span><span class="mono">Stacked</span></div>
      </div>
      <div class="chart">
        <canvas id="chDayNight"></canvas>
      </div>
    </div>

  </div>

  <!-- ================= BOTTOM SECTION ================= -->
  <div class="grid-bottom">

    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Filiallar kesimida Ortish va Tushirish umumiy grafik</h3>
          <div class="card-sub"> Ortish (koâ€˜k), Tushirish (pushti) </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <div class="chip"><span class="dot info"></span><span class="mono">Stations</span></div>
          <button id="btnSortStations" class="btnx" type="button"><span>â‡…</span><span>Sort</span></button>
        </div>
      </div>
      <div class="chart" style="height: 560px;">
        <canvas id="chStations"></canvas>
      </div>
    </div>

    <!-- âœ… REPLACED: Online Users table -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3 class="card-title">Online foydalanuvchilar</h3>
          <div class="card-sub">Oxirgi login va hozirgi holat</div>
        </div>
        <a class="btnx" href="{% url 'admin_table1_reports' %}">
          <span>ðŸ‘¤</span><span>Users</span>
        </a>
      </div>

      <div class="table-wrap">
        <div class="scroll-x">
          <table class="tbl" id="onlineUsersTable">
            <thead>
              <tr>
                <th>Foydalanuvchi</th>
                <th>Boâ€˜lim</th>
                <th>Oxirgi login</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody>
              <!-- JS will fill -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

</div>

{{ dash_json|json_script:"dash-json" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


<script>
(function(){
  // ============================================================
  // 0) Read server-provided JSON (admin_settings initial payload)
  // ============================================================
  const raw = document.getElementById("dash-json");
  let D = {};
  try { D = JSON.parse(raw?.textContent || "{}"); } catch(e){ D = {}; }

  // ============================================================
  // 1) Helpers
  // ============================================================
  const spaced = (n)=> (Number(n || 0)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  const isDark = ()=> document.documentElement.getAttribute("data-theme")==="dark";
  function gridColor(){
    return isDark() ? "rgba(255,255,255,.10)" : "rgba(15,23,42,.10)";
  }
  function gridColorSoft(){
    return isDark() ? "rgba(255,255,255,.06)" : "rgba(15,23,42,.06)";
  }

  // ============================================================
  // 2) Date range badge
  // ============================================================
  const $from = document.getElementById("dateFrom");
  const $to = document.getElementById("dateTo");
  const $badge = document.getElementById("rangeBadge");

  function fmtRange(a,b){
    if(!a && !b) return "All time";
    if(a && !b) return a + " â†’ â€¦";
    if(!a && b) return "â€¦ â†’ " + b;
    return a + " â†’ " + b;
  }
  if($badge){
    $badge.textContent = fmtRange($from?.value || D.range?.from, $to?.value || D.range?.to);
  }

  function rangeQS(){
    const qs = new URLSearchParams();
    const f = $from?.value || "";
    const t = $to?.value || "";
    if(f) qs.set("from", f);
    if(t) qs.set("to", t);
    const s = qs.toString();
    return s ? ("?" + s) : "";
  }

  // ============================================================
  // 3) KPI fill (from backend totals)
  // Mapping:
  //   - Ortish / Pogruzka      -> totals.pogr
  //   - Tushirish / Vigruzka   -> totals.vygr
  //   - Ortishda / Podpogruzka -> totals.pod_pogr
  //   - Tushirishda/Podvigruzka-> totals.pod_vygr
  // ============================================================
  const totals = D.totals || {};
  const elOrt = document.getElementById("kpiOrtish");
  const elTush = document.getElementById("kpiTushirish");
  const elPodOrt = document.getElementById("kpiPodpogruzka");
  const elPodTush = document.getElementById("kpiPodvigruzka");

  if(elOrt) elOrt.textContent = spaced(totals.pogr ?? 0);
  if(elTush) elTush.textContent = spaced(totals.vygr ?? 0);
  if(elPodOrt) elPodOrt.textContent = spaced(totals.pod_pogr ?? 0);
  if(elPodTush) elPodTush.textContent = spaced(totals.pod_vygr ?? 0);

  // ============================================================
  // 4) Chart.js setup
  // ============================================================
  if(typeof Chart === "undefined"){
    console.error("Chart.js not loaded");
    return;
  }

  Chart.defaults.font.family =
    'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  Chart.defaults.color =
    getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#111827';

  const shadowPlugin = {
    id: "shadowPlugin",
    beforeDatasetsDraw(chart, args, opts) {
      const { ctx } = chart;
      ctx.save();
      ctx.shadowColor = opts?.shadowColor || (isDark() ? "rgba(0,0,0,.60)" : "rgba(15,23,42,.18)");
      ctx.shadowBlur  = opts?.shadowBlur ?? 18;
      ctx.shadowOffsetX = opts?.shadowOffsetX ?? 0;
      ctx.shadowOffsetY = opts?.shadowOffsetY ?? 10;
    },
    afterDatasetsDraw(chart) {
      chart.ctx.restore();
    }
  };
  Chart.register(shadowPlugin);

  function safeChart(make){
    try { return make(); }
    catch(e){ console.error("Chart error:", e); return null; }
  }

  // ============================================================
  // 5) Income mini (uses D.incomeMini from admin_settings)
  // ============================================================
  const upColor = "rgba(34,197,94,0.98)";
  const downColor = "rgba(239,68,68,0.98)";

  let chIncomeMini = null;
  if(D.incomeMini?.labels?.length){
    chIncomeMini = safeChart(()=> new Chart(document.getElementById("chIncomeMini"), {
      type: "line",
      data: {
        labels: D.incomeMini.labels,
        datasets: [{
          label: "Daromad",
          data: D.incomeMini.values || [],
          tension: 0.22,
          pointRadius: 0,
          borderWidth: 2,
          segment: {
            borderColor: (ctx) => {
              const y0 = ctx.p0.parsed.y;
              const y1 = ctx.p1.parsed.y;
              return (y1 >= y0) ? upColor : downColor;
            },
          },
          fill: true,
          backgroundColor: "rgba(56,189,248,0.10)"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          shadowPlugin: { shadowBlur: 22, shadowOffsetY: 10 },
          legend: { display: false },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          x: { grid: { color: gridColorSoft() } },
          y: { grid: { color: gridColor() }, ticks: { precision: 0 } }
        }
      }
    }));
  }

  // ============================================================
  // 6) Structure (Top-5 income_daily this month) - from admin_settings
  // ============================================================
  let chStructure = null;
  if(D.structure?.labels?.length){
    chStructure = safeChart(()=> new Chart(document.getElementById("chStructure"), {
      type: "bar",
      data: {
        labels: D.structure.labels,
        datasets: [{
          label: "Daromad",
          data: D.structure.values || [],
          borderWidth: 0,
          borderRadius: 12,
          barThickness: 18,
          maxBarThickness: 22
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: { shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 }, legend: { position: "top" } },
        scales: {
          x: { grid: { display:false } },
          y: { beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));
  }

  // ============================================================
  // 7) Lazy-loaded blocks via JSON endpoints
  //   - monthly:          /admin/settings/monthly.json
  //   - stations:         /admin/settings/stations.json
  //   - stacked top-5:    /admin/settings/stacked-top5.json
  //   - online users:     /admin/settings/online-users.json
  // ============================================================
  let chMonthly = null;
  let chDayNight = null;
  let chStations = null;
  let stationsSorted = false;
  let stationsRaw = null;

  function renderMonthly(M){
    if(!M?.labels?.length) return;
    if(chMonthly) chMonthly.destroy();
    chMonthly = safeChart(()=> new Chart(document.getElementById("chMonthly"), {
      type: "line",
      data: {
        labels: M.labels,
        datasets: [
          { label: "Ortish", data: M.ortish || [], tension: 0.30, borderWidth: 2, pointRadius: 3, fill: false },
          { label: "Tushirish", data: M.tushirish || [], tension: 0.30, borderWidth: 2, pointRadius: 3, fill: false }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: { shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 }, legend: { position: "top" } },
        scales: {
          x: { grid: { display:false } },
          y: { beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));
  }

  function renderStacked(S){
    if(!S?.labels?.length) return;
    if(chDayNight) chDayNight.destroy();
    chDayNight = safeChart(()=> new Chart(document.getElementById("chDayNight"), {
      type: "bar",
      data: {
        labels: S.labels,
        datasets: [
          { label: "Podpogruzka", data: S.day || [], stack: "s", borderWidth: 0, borderRadius: 12, barThickness: 18, maxBarThickness: 22 },
          { label: "Podvigruzka", data: S.night || [], stack: "s", borderWidth: 0, borderRadius: 12, barThickness: 18, maxBarThickness: 22 }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins: { shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 }, legend: { position: "bottom" } },
        scales: {
          x: { stacked:true, grid: { display:false } },
          y: { stacked:true, beginAtZero:true, grid: { color: gridColor() }, ticks: { precision:0 } }
        }
      }
    }));
  }

  function buildStationsData(sorted){
    const labels = [...(stationsRaw?.labels || [])];
    const ort = [...(stationsRaw?.ortish || [])];
    const tus = [...(stationsRaw?.tushirish || [])];

    if(sorted){
      const idx = labels.map((_,i)=>i).sort((a,b)=> (ort[b]+tus[b]) - (ort[a]+tus[a]));
      return { labels: idx.map(i=>labels[i]), ortish: idx.map(i=>ort[i]), tushirish: idx.map(i=>tus[i]) };
    }
    return { labels, ortish: ort, tushirish: tus };
  }

  function renderStations(sorted){
    if(!stationsRaw?.labels?.length) return;
    const X = buildStationsData(sorted);

    if(chStations) chStations.destroy();
    chStations = safeChart(()=> new Chart(document.getElementById("chStations"), {
      type: "bar",
      data: {
        labels: X.labels,
        datasets: [
          { label: "Ortish", data: X.ortish, stack:"s", borderWidth:0, borderRadius: 12, barThickness: 16, maxBarThickness: 20 },
          { label: "Tushirish", data: X.tushirish, stack:"s", borderWidth:0, borderRadius: 12, barThickness: 16, maxBarThickness: 20 }
        ]
      },
      options: {
        indexAxis: "y",
        responsive:true,
        maintainAspectRatio:false,
        plugins: { shadowPlugin: { shadowBlur: 18, shadowOffsetY: 9 }, legend: { position: "top" } },
        scales: {
          x: { stacked:true, grid: { color: gridColor() }, ticks: { precision:0 } },
          y: { stacked:true, grid: { display:false } }
        }
      }
    }));
  }

  function renderOnlineUsers(list){
    const usersTbody = document.querySelector("#onlineUsersTable tbody");
    if(!usersTbody) return;

    const badge = (online)=>{
      if(online) return '<span class="chip"><span class="dot"></span><span>Online</span></span>';
      return '<span class="chip"><span class="dot warn"></span><span>Offline</span></span>';
    };

    usersTbody.innerHTML = (list || []).map(u=>`
      <tr>
        <td><b>${u.name}</b></td>
        <td class="mono">${u.department || "-"}</td>
        <td class="mono">${u.last_login || "-"}</td>
        <td>${badge(!!u.online)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="mono" style="color:var(--muted)">Ma'lumot yoâ€˜q</td></tr>`;
  }

  async function fetchJSON(url){
    const r = await fetch(url, { credentials: "same-origin" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    return await r.json();
  }

  async function loadMonthly(){
    const data = await fetchJSON("{% url 'admin_settings_monthly_json' %}");
    renderMonthly(data.monthly);
  }

  async function loadStations(){
    const data = await fetchJSON("{% url 'admin_settings_stations_json' %}" + rangeQS());
    stationsRaw = data.stations;
    renderStations(stationsSorted);
  }

  async function loadStacked(){
    const data = await fetchJSON("{% url 'admin_settings_stacked_top5_json' %}" + rangeQS());
    renderStacked(data.dayNightTop);
  }

  async function loadOnline(){
    const data = await fetchJSON("{% url 'admin_settings_online_users_json' %}");
    renderOnlineUsers(data.online_users);
  }

  // initial background loads
  Promise.allSettled([loadMonthly(), loadStations(), loadStacked(), loadOnline()]);

  // sort button
  document.getElementById("btnSortStations")?.addEventListener("click", ()=>{
    stationsSorted = !stationsSorted;
    renderStations(stationsSorted);
  });

})();
</script>

{% endblock %}