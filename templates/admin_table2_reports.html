{% extends "base.html" %}
{% block title %}Admin hisobot №2{% endblock %}

{% block content %}
<style>
  .panel{
    background: var(--surface);
    border: 1px solid var(--stroke);
    border-radius: 20px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px);
    padding: 16px;
  }
  .hdr{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
  }
  .hdr h2{margin:0;font-size:18px;font-weight:950;color:var(--text);}
  .muted{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4;}

  .tableWrap{
    margin-top: 14px;
    overflow:auto;
    border-radius: 18px;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,.30);
  }
  html[data-theme="dark"] .tableWrap{ background: rgba(255,255,255,.04); }

  table{width:100%;min-width:1100px;border-collapse:separate;border-spacing:0;}
  thead th{
    position:sticky;top:0;z-index:2;
    text-align:left;font-size:12.5px;font-weight:950;color:var(--text);
    background:var(--surface);
    border-bottom:1px solid var(--stroke);
    padding:12px 12px;white-space:nowrap;
  }
  tbody td{
    padding:12px 12px;
    border-bottom:1px solid rgba(15,23,42,.06);
    color:var(--text);
    font-size:13px;
    vertical-align:middle;
    background:transparent;
  }
  html[data-theme="dark"] tbody td{ border-bottom:1px solid rgba(255,255,255,.08); }
  tbody tr:hover td{ background: rgba(79,70,229,.06); }
  html[data-theme="dark"] tbody tr:hover td{ background: rgba(99,102,241,.10); }

  .num{font-weight:950;opacity:.85;width:70px;}
  .date{font-weight:950;font-size:14px;}
  .submeta{margin-top:2px;color:var(--muted);font-size:12px;}

  .statusBtn{
    display:inline-flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.55);
    cursor:pointer;font-weight:950;color:var(--text);
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    white-space:nowrap;
  }
  html[data-theme="dark"] .statusBtn{ background:rgba(255,255,255,.06); }
  .statusBtn:hover{ transform:translateY(-1px); box-shadow:0 16px 44px rgba(15,23,42,.10); filter:brightness(1.02); }

  .statusBadge{
    padding:3px 10px;border-radius:999px;font-size:12px;
    border:1px solid rgba(15,23,42,.12);
    background:linear-gradient(135deg, rgba(79,70,229,.14), rgba(34,197,94,.12), rgba(6,182,212,.12));
  }
  html[data-theme="dark"] .statusBadge{ border-color:rgba(255,255,255,.14); }

  /* Action buttons */
  .actions{display:flex;gap:8px;flex-wrap:wrap;}
  .btnA{
    display:inline-flex;align-items:center;justify-content:center;
    padding:10px 12px;border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.55);
    color:var(--text);
    font-weight:950;
    text-decoration:none;
    white-space:nowrap;
    transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  html[data-theme="dark"] .btnA{ background:rgba(255,255,255,.06); }
  .btnA:hover{ transform:translateY(-1px); box-shadow:0 16px 44px rgba(15,23,42,.10); filter:brightness(1.02); }

  .btnPrimary{
    
    
    
    box-shadow:0 14px 40px rgba(79,70,229,.18);
  }
  .btnPrimary:hover{ filter:brightness(1.03); }

  /* Modal */
  .modal{
    position:fixed;inset:0;
    background:rgba(0,0,0,.35);
    display:none;align-items:center;justify-content:center;
    padding:18px;z-index:999;
  }
  .modal.open{display:flex;}
  .modalCard{
    width:min(480px,100%);
    border-radius:18px;border:1px solid var(--stroke);
    background:var(--surface);box-shadow:var(--shadow2);
    backdrop-filter:blur(14px);overflow:hidden;
  }
  .modalTop{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:14px 16px;border-bottom:1px solid var(--stroke);
  }
  .modalTop b{font-size:14px;letter-spacing:.2px;}
  .closeBtn{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.55);
    border-radius:12px;width:40px;height:36px;
    cursor:pointer;font-weight:950;color:var(--text);
  }
  html[data-theme="dark"] .closeBtn{ background:rgba(255,255,255,.06); }
  .modalBody{padding:14px 16px 16px;}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  @media(max-width:820px){ .cols{grid-template-columns:1fr;} }
  .col{
    border:1px solid var(--stroke);
    border-radius:16px;padding:12px;
    background:rgba(255,255,255,.35);
    max-height:320px;overflow:auto;
  }
  html[data-theme="dark"] .col{ background:rgba(255,255,255,.04); }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:5px 10px;border-radius:999px;
    font-weight:950;font-size:12px;border:1px solid var(--stroke);
  }
  .pill.ok{ background:rgba(34,197,94,.12); }
  .pill.no{ background:rgba(239,68,68,.10); }
  .stLine{
    display:flex;justify-content:space-between;gap:10px;
    padding:8px 0;border-bottom:1px dashed rgba(15,23,42,.12);
  }
  html[data-theme="dark"] .stLine{ border-bottom:1px dashed rgba(255,255,255,.14); }
  .stLine:last-child{border-bottom:none;}
  .stName{font-weight:900;}
  .stTime{font-size:12px;color:var(--muted);white-space:nowrap;}

  /* Front pagination */
  .pager{
    margin-top:14px;
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  }
  .pager .left{color:var(--muted);font-size:12.5px;}
  .pager .right{display:flex;gap:8px;flex-wrap:wrap;}
  .pgBtn{
    padding:9px 12px;border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.55);
    color:var(--text);
    font-weight:950;font-size:12.5px;
    cursor:pointer;
  }
  html[data-theme="dark"] .pgBtn{ background:rgba(255,255,255,.06); }
  .pgBtn:disabled{opacity:.5;cursor:not-allowed;}
</style>

<div class="panel">
  <div class="hdr">
    <div>
      <h2>Admin hisobot №2</h2>
      <div class="muted">
        “Отправили X/Y” tugmasini bosing — kim jo‘natgan/kim jo‘natmagan ko‘rasiz.
        Pastdagi Oldingi/Keyingi tugmalar bilan 10 tadan sahifalanadi (frontend).
      </div>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:70px;">№</th>
          <th>Sana / Oy / Yil</th>
          <th>Filiallar holati</th>
          <th>Oxirgi jo‘natish</th>
          <th>Amallar</th>
        </tr>
      </thead>
      <tbody id="t2Body">
        {% for it in items %}
          <tr class="t2-row">
            <td class="num t2-num"></td>

            <td>
              <div class="date">{{ it.date|date:"d.m.Y" }}</div>
              <div class="submeta">Yil: <b>{{ it.year }}</b> • Oy: <b>{{ it.month }}</b></div>
            </td>

            <td>
              <button type="button"
                      class="statusBtn"
                      data-open="t2m-{{ forloop.counter }}">
                <span class="statusBadge">
                  Jo'natganlar <b>{{ it.submitted_count }}/{{ it.total_count }}</b>
                </span>
                <span style="opacity:.8">Batafsil</span>
              </button>

              <div class="modal" id="t2m-{{ forloop.counter }}">
                <div class="modalCard" role="dialog" aria-modal="true">
                  <div class="modalTop">
                    <b>Filiallar holati — {{ it.date|date:"d.m.Y" }}</b>
                    <button type="button" class="closeBtn" data-close="t2m-{{ forloop.counter }}">×</button>
                  </div>

                  <div class="modalBody">
                    <div class="cols">
                      <div class="col">
                        <div style="margin-bottom:10px;">
                          <span class="pill ok">Отправили ({{ it.submitted_count }})</span>
                        </div>
                        {% for s in it.submitted %}
                          <div class="stLine">
                            <div class="stName">{{ s.name }}</div>
                            <div class="stTime">{{ s.submitted_at|date:"d.m.Y H:i" }}</div>
                          </div>
                        {% empty %}
                          <div class="stTime">Hech kim jo‘natmagan</div>
                        {% endfor %}
                      </div>

                      <div class="col">
                        <div style="margin-bottom:10px;">
                          <span class="pill no">Не отправили ({{ it.not_submitted_count }})</span>
                        </div>
                        {% for s in it.not_submitted %}
                          <div class="stLine">
                            <div class="stName">{{ s.name }}</div>
                            <div class="stTime">—</div>
                          </div>
                        {% empty %}
                          <div class="stTime">Hamma jo‘natgan</div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </td>

            <td>
              {% if it.submitted_at %}
                <b>{{ it.submitted_at|date:"d.m.Y H:i" }}</b>
              {% else %}
                —
              {% endif %}
            </td>

            <td>
              <div class="actions">
                <a class="btnA btnPrimary" href="{% url 'admin_table2_station_pick' it.date|date:'Y-m-d' %}">
                  Filiallar kesimida
                </a>
                <a class="btnA" href="{% url 'admin_table2_graph' it.date|date:'Y-m-d' %}">
                  jadval-1
                </a>
                <a class="btnA" href="{% url 'admin_table2_layout' it.date|date:'Y-m-d' %}">
                  jadval-2
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" style="padding:16px;color:var(--muted);">
              Пока нет отчётов Таблицы 2.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="pager">
    <div class="left" id="t2Info">—</div>
    <div class="right">
      <button class="pgBtn" id="t2Prev" type="button">‹ Oldingi</button>
      <button class="pgBtn" id="t2Next" type="button">Keyingi ›</button>
    </div>
  </div>
</div>

<script>
(function(){
  // Modal open/close
  function openModal(id){
    const m = document.getElementById(id);
    if(!m) return;
    m.classList.add('open');
    document.body.style.overflow='hidden';
  }
  function closeModal(id){
    const m = document.getElementById(id);
    if(!m) return;
    m.classList.remove('open');
    document.body.style.overflow='';
  }

  document.addEventListener('click', (e)=>{
    const ob = e.target.closest('[data-open]');
    if(ob){ openModal(ob.getAttribute('data-open')); return; }

    const cb = e.target.closest('[data-close]');
    if(cb){ closeModal(cb.getAttribute('data-close')); return; }

    if(e.target.classList && e.target.classList.contains('modal')){
      e.target.classList.remove('open');
      document.body.style.overflow='';
    }
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
      document.body.style.overflow='';
    }
  });

  // Front pagination (10 rows)
  const rows = Array.from(document.querySelectorAll('#t2Body .t2-row'));
  const perPage = 10;
  let page = 1;
  const totalPages = Math.max(1, Math.ceil(rows.length / perPage));

  const info = document.getElementById('t2Info');
  const prev = document.getElementById('t2Prev');
  const next = document.getElementById('t2Next');

  function render(){
    const start = (page-1)*perPage;
    const end = start + perPage;

    rows.forEach((r, idx)=>{
      const show = idx >= start && idx < end;
      r.style.display = show ? '' : 'none';
      if(show){
        const nCell = r.querySelector('.t2-num');
        if(nCell) nCell.textContent = (idx + 1).toString();
      }
    });

    info.textContent = `Sahifa ${page}/${totalPages} • Jami: ${rows.length}`;
    prev.disabled = page <= 1;
    next.disabled = page >= totalPages;
  }

  prev.addEventListener('click', ()=>{ if(page>1){ page--; render(); window.scrollTo({top:0,behavior:'smooth'});} });
  next.addEventListener('click', ()=>{ if(page<totalPages){ page++; render(); window.scrollTo({top:0,behavior:'smooth'});} });

  render();
})();
</script>
{% endblock %}
