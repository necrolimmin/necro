{% extends "base.html" %}
{% block title %}Hisobot №1{% endblock %}

{% block content %}
<style>
  /* ===== Header ===== */
  .pagehead{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap}
  .pagehead h2{margin:0;font-size:20px;line-height:1.15;letter-spacing:-.02em}
  .subtext{margin:6px 0 0;color:var(--muted,#64748b);font-size:14px}

  /* ===== CTA button ===== */
  .btn-cta{
    display:inline-flex;align-items:center;gap:10px;
    padding:6px 15px;border-radius:999px;
    font-weight:700;text-decoration:none;color:#fff;
    background:linear-gradient(135deg,#4f46e5,#22c55e);
    box-shadow:0 14px 30px rgba(79,70,229,.28);
    transition:.22s ease;
    position:relative;overflow:hidden;
    white-space:nowrap;
  }
  .btn-cta svg{width:18px;height:18px;stroke:#fff}
  .btn-cta::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(120deg,transparent,rgba(255,255,255,.35),transparent);
    transform:translateX(-120%);transition:.65s ease;
  }
  .btn-cta:hover{transform:translateY(-2px);box-shadow:0 22px 42px rgba(79,70,229,.36)}
  .btn-cta:hover::after{transform:translateX(120%)}

  /* ===== Controls ===== */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
  .search{
    flex:1;min-width:220px;
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(15,23,42,.12);
    /* background:rgba(255,255,255,.72); */
    backdrop-filter: blur(10px);
  }
  .search .ico{font-weight:900;color:var(--muted,#64748b)}
  .search input{
    width:100%;border:0;outline:0;background:transparent;
    font-size:14px;color:inherit;
  }
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(15,23,42,.12);
    /* background:rgba(255,255,255,.72); */
    backdrop-filter: blur(10px);
    font-size:13px;color:var(--muted,#64748b);
    white-space:nowrap;
  }

  .tblwrap{
    margin-top:14px;
    border:1px solid rgba(15,23,42,.12);
    border-radius:16px;
    overflow:hidden;
    /* background:rgba(255,255,255,.78); */
    backdrop-filter: blur(10px);
  }
  table.tbl2{width:100%;border-collapse:separate;border-spacing:0}
  .tbl2 thead th{
    text-align:left;
    font-size:12px;letter-spacing:.2px;
    color:var(--muted,#64748b);
    padding:12px 12px;
    background:rgba(248,250,252,.9);
    border-bottom:1px solid rgba(15,23,42,.10);
    position:sticky;top:0;z-index:2;
  }
  .tbl2 thead th:last-child{text-align:right}
  .tbl2 tbody td{
    padding:12px 12px;
    border-bottom:1px solid rgba(15,23,42,.08);
    vertical-align:middle;
    font-size:14px;
  }
  .tbl2 tbody tr:hover{background:rgba(99,102,241,.06)}
  .dateCell b{font-size:14px}
  .mutedCell{color:var(--muted,#64748b);font-size:13px}

  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .btn-soft{
    display:inline-flex;align-items:center;justify-content:center;
    height:38px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    text-decoration:none;color:inherit;
    font-weight:800;
    transition:.15s ease;
  }
  .btn-soft:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(15,23,42,.08)}
  .btn-danger{
    height:38px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(220,38,38,.30);
    background:rgba(254,226,226,.9);
    color:#991b1b;font-weight:900;
    cursor:pointer;
    transition:.15s ease;
  }
  .btn-danger:hover{filter:brightness(.98);transform:translateY(-1px)}

  /* ===== Server Pager ===== */
  .pager{
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    padding:12px;
    border-top:1px solid rgba(15,23,42,.10);
    background:rgba(248,250,252,.75);
  }
  .pager .info{color:var(--muted,#64748b);font-size:13px}
  .pager a, .pager button{
    height:36px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    font-weight:900;cursor:pointer;
    text-decoration:none;color:inherit;
    display:inline-flex;align-items:center;justify-content:center;
  }
  .pager .disabled{opacity:.5;pointer-events:none}
  .pager .pnums{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center}
  .pager .pnum.active{
    border-color: rgba(99,102,241,.45);
    box-shadow: 0 10px 18px rgba(99,102,241,.18);
  }
  .pager .pp{
    display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .pager select{
    height:36px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    padding:0 10px;font-weight:800;
  }

  /* ===== Mobile ===== */
  @media (max-width: 820px){
    .tbl2 thead{display:none}
    .tbl2, .tbl2 tbody, .tbl2 tr, .tbl2 td{display:block;width:100%}
    .tbl2 tbody tr{border-bottom:1px solid rgba(15,23,42,.10);padding:10px 10px 12px}
    .tbl2 tbody td{border-bottom:0;padding:6px 8px}
    .rowgrid{
      display:grid;grid-template-columns:1fr;gap:6px;
      background:rgba(255,255,255,.85);
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px;
    }
    .kv{display:flex;justify-content:space-between;gap:12px;font-size:13px;color:var(--muted,#64748b)}
    .kv b{color:inherit;font-weight:900}
    .actions{justify-content:flex-start;margin-top:8px}
  }

  /* ===== Dark mode ===== */
  html[data-theme="dark"] .search,
  html[data-theme="dark"] .chip,
  html[data-theme="dark"] .tblwrap{
    background:rgba(15,23,42,.55);
    border-color: rgba(148,163,184,.18);
  }
  html[data-theme="dark"] .tbl2 thead th{
    background:rgba(15,23,42,.65);
    border-bottom-color: rgba(148,163,184,.16);
    color: rgba(226,232,240,.75);
  }
  html[data-theme="dark"] .tbl2 tbody td{border-bottom-color: rgba(148,163,184,.14)}
  html[data-theme="dark"] .tbl2 tbody tr:hover{background:rgba(99,102,241,.10)}
  html[data-theme="dark"] .btn-soft,
  html[data-theme="dark"] .pager a,
  html[data-theme="dark"] .pager select{
    background:rgba(15,23,42,.75);
    border-color: rgba(148,163,184,.18);
    color: rgba(226,232,240,.92);
  }
  html[data-theme="dark"] .pager{
    background:rgba(15,23,42,.45);
    border-top-color: rgba(148,163,184,.16);
  }
</style>

<div class="card">
  <div class="pagehead">
    <div>
      <h2 data-i18n="t1_reports_title">Hisobot №1</h2>
      <div class="subtext" data-i18n="t1_reports_sub">
        Sana bo‘yicha hisobotlar ro‘yxati. Qidiruv orqali tez topishingiz mumkin.
      </div>
    </div>

    <a class="btn-cta" href="{% url 'station_table_1_edit' today %}?new=1" data-i18n="create_report">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Hisobot yaratish
    </a>
  </div>

  <div class="controls">
    <div class="search">
      <span class="ico">⌕</span>
      <input id="q" type="text"
             placeholder="Sana / yil / vaqt bo‘yicha qidirish…"
             data-i18n-placeholder="search_placeholder">
    </div>

    <div class="chip">
      <span data-i18n="shown">Ko‘rsatilmoqda</span>:
      <b id="shownCount">{{ rows|length }}</b>
    </div>

    <div class="chip">
      <span data-i18n="total">Jami</span>:
      <b id="totalCount">{{ paginator.count }}</b>
    </div>
  </div>

  <div class="tblwrap">
    <table class="tbl2" id="t1table">
      <thead>
        <tr>
          <th style="width:180px" data-i18n="col_date">Sana</th>
          <th style="width:90px" data-i18n="col_year">Yil</th>
          <th style="width:190px" data-i18n="col_sent">Jo'natilgan</th>
          <th style="width:360px;text-align:right" data-i18n="col_actions">Amallar</th>
        </tr>
      </thead>

      <tbody id="t1body">
        {% for r in rows %}
        <tr class="t1row"
            data-search="{{ r.date|date:'d.m.Y' }} {{ r.date|date:'Y-m-d' }} {{ r.year }} {% if r.submitted_at %}{{ r.submitted_at|date:'d.m.Y H:i' }}{% endif %}">
          <td class="dateCell"><b>{{ r.date|date:"d.m.Y" }}</b></td>
          <td>{{ r.year }}</td>
          <td class="mutedCell">
            {% if r.submitted_at %}{{ r.submitted_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}
          </td>
          <td>
            <div class="actions">
              <a class="btn-soft" href="/station/table-1/view/{{ r.date|date:'Y-m-d' }}/" data-i18n="view">Ko'rish</a>
              <a class="btn-soft" href="/station/table-1/edit/{{ r.date|date:'Y-m-d' }}/" data-i18n="edit">Tahrirlash</a>

              <form method="post"
                    action="/station/table-1/delete/{{ r.date|date:'Y-m-d' }}/"
                    style="display:inline;"
                    onsubmit="return confirm(window.__t?.confirm_delete || 'Удалить отчёт?');">
                {% csrf_token %}
                <button class="btn-danger" type="submit" data-i18n="delete">O'chirish</button>
              </form>
            </div>

            <div class="rowgrid" style="display:none">
              <div class="kv"><span data-i18n="col_date">Sana</span><b>{{ r.date|date:"d.m.Y" }}</b></div>
              <div class="kv"><span data-i18n="col_year">Yil</span><b>{{ r.year }}</b></div>
              <div class="kv"><span data-i18n="col_sent">Jo'natilgan</span>
                <b>{% if r.submitted_at %}{{ r.submitted_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}</b>
              </div>
              <div class="actions">
                <a class="btn-soft" href="/station/table-1/view/{{ r.date|date:'Y-m-d' }}/" data-i18n="view">Ko'rish</a>
                <a class="btn-soft" href="/station/table-1/edit/{{ r.date|date:'Y-m-d' }}/" data-i18n="edit">Tahrirlash</a>
                <form method="post"
                      action="/station/table-1/delete/{{ r.date|date:'Y-m-d' }}/"
                      style="display:inline;"
                      onsubmit="return confirm(window.__t?.confirm_delete || 'Удалить отчёт?');">
                  {% csrf_token %}
                  <button class="btn-danger" type="submit" data-i18n="delete">O'chirish</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="padding:16px;color:var(--muted,#64748b)">
            <span data-i18n="empty">Пока нет отчётов. Нажми “Создать отчёт”.</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if paginator.num_pages > 1 %}
    <div class="pager">
      <div class="info">
        {{ page_obj.start_index }}–{{ page_obj.end_index }} / {{ paginator.count }}
      </div>

      <div class="pp">
        {# per_page selector keeps page=1 #}
        <form method="get" style="display:inline-flex;gap:8px;align-items:center">
          <input type="hidden" name="page" value="1">
          <select name="per_page" onchange="this.form.submit()">
            <option value="5"  {% if per_page == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
          </select>
        </form>

        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}">‹</a>
        {% else %}
          <a class="disabled">‹</a>
        {% endif %}

        <div class="pnums">
          {% for n in page_obj.paginator.page_range %}
            {% if n >= page_obj.number|add:-3 and n <= page_obj.number|add:3 %}
              <a class="pnum {% if n == page_obj.number %}active{% endif %}"
                 href="?page={{ n }}&per_page={{ per_page }}">{{ n }}</a>
            {% endif %}
          {% endfor %}
        </div>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}">›</a>
        {% else %}
          <a class="disabled">›</a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
(function(){
  // mobile card switch
  function syncMobileRows(){
    const isMobile = window.matchMedia("(max-width: 820px)").matches;
    document.querySelectorAll(".t1row").forEach(tr=>{
      const rowgrid = tr.querySelector(".rowgrid");
      if(rowgrid) rowgrid.style.display = isMobile ? "grid" : "none";
    });
  }
  window.addEventListener("resize", syncMobileRows);
  syncMobileRows();

  // quick filter (filters current page only)
  const q = document.getElementById("q");
  const rows = Array.from(document.querySelectorAll(".t1row"));
  const shownCount = document.getElementById("shownCount");

  function applyFilter(){
    const term = (q.value || "").trim().toLowerCase();
    let shown = 0;
    rows.forEach(r=>{
      const ok = !term || (r.dataset.search || "").toLowerCase().includes(term);
      r.style.display = ok ? "" : "none";
      if(ok) shown++;
    });
    shownCount.textContent = String(shown);
  }

  q && q.addEventListener("input", applyFilter);
})();
</script>
<script>
setInterval(()=>fetch("/heartbeat/", {credentials:"same-origin"}), 30000);
</script>
{% endblock %}
