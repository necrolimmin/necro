{% extends "base.html" %}
{% block title %}Hisobot №1{% endblock %}

{% block content %}
<style>
  /* ===== Header ===== */
  .pagehead{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap}
  .pagehead h2{margin:0;font-size:20px;line-height:1.15;letter-spacing:-.02em}
  .subtext{margin:6px 0 0;color:var(--muted,#64748b);font-size:14px}


  /* ===== CTA button ===== */
  .btn-cta{
    display:inline-flex;align-items:center;gap:10px;
    padding:6px 15px;border-radius:999px;
    font-weight:700;text-decoration:none;color:#fff;
    background:linear-gradient(135deg,#4f46e5,#22c55e);
    box-shadow:0 14px 30px rgba(79,70,229,.28);
    transition:.22s ease;
    position:relative;overflow:hidden;
    white-space:nowrap;
  }
  .btn-cta svg{width:18px;height:18px;stroke:#fff}
  .btn-cta::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(120deg,transparent,rgba(255,255,255,.35),transparent);
    transform:translateX(-120%);transition:.65s ease;
  }
  .btn-cta:hover{transform:translateY(-2px);box-shadow:0 22px 42px rgba(79,70,229,.36)}
  .btn-cta:hover::after{transform:translateX(120%)}

  /* ===== Controls ===== */
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
  .search{
    flex:1;min-width:220px;
    display:flex;align-items:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.72);
    backdrop-filter: blur(10px);
  }
  .search .ico{font-weight:900;color:var(--muted,#64748b)}
  .search input{
    width:100%;border:0;outline:0;background:transparent;
    font-size:14px;color:inherit;
  }
  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.72);
    backdrop-filter: blur(10px);
    font-size:13px;color:var(--muted,#64748b);
    white-space:nowrap;
  }

  /* ===== Table Wrap (glass) ===== */
  .tblwrap{
    margin-top:14px;
    border:1px solid rgba(15,23,42,.12);
    border-radius:16px;
    overflow:hidden;
    background:rgba(255,255,255,.78);
    backdrop-filter: blur(10px);
  }
  table.tbl2{width:100%;border-collapse:separate;border-spacing:0}
  .tbl2 thead th{
    text-align:left;
    font-size:12px;letter-spacing:.2px;
    color:var(--muted,#64748b);
    padding:12px 12px;
    background:rgba(248,250,252,.9);
    border-bottom:1px solid rgba(15,23,42,.10);
    position:sticky;top:0;z-index:2;
  }
  .tbl2 thead th:last-child{text-align:right}
  .tbl2 tbody td{
    padding:12px 12px;
    border-bottom:1px solid rgba(15,23,42,.08);
    vertical-align:middle;
    font-size:14px;
  }
  .tbl2 tbody tr:hover{background:rgba(99,102,241,.06)}
  .dateCell b{font-size:14px}
  .mutedCell{color:var(--muted,#64748b);font-size:13px}

  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .btn-soft{
    display:inline-flex;align-items:center;justify-content:center;
    height:38px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    text-decoration:none;color:inherit;
    font-weight:800;
    transition:.15s ease;
  }
  .btn-soft:hover{transform:translateY(-1px);box-shadow:0 10px 18px rgba(15,23,42,.08)}
  .btn-danger{
    height:38px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(220,38,38,.30);
    background:rgba(254,226,226,.9);
    color:#991b1b;font-weight:900;
    cursor:pointer;
    transition:.15s ease;
  }
  .btn-danger:hover{filter:brightness(.98);transform:translateY(-1px)}

  /* ===== Pagination ===== */
  .pager{
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    padding:12px;
    border-top:1px solid rgba(15,23,42,.10);
    background:rgba(248,250,252,.75);
  }
  .pager .info{color:var(--muted,#64748b);font-size:13px}
  .pager .pbtn{
    height:36px;padding:0 12px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    font-weight:900;cursor:pointer;
  }
  .pager .pbtn:disabled{opacity:.5;cursor:not-allowed}
  .pager .pnums{display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center}
  .pager .pnum{
    height:34px;min-width:34px;padding:0 10px;border-radius:12px;
    border:1px solid rgba(15,23,42,.12);
    background:rgba(255,255,255,.9);
    font-weight:900;cursor:pointer;
  }
  .pager .pnum.active{
    border-color: rgba(99,102,241,.45);
    box-shadow: 0 10px 18px rgba(99,102,241,.18);
  }

  /* ===== Mobile: table -> cards ===== */
  @media (max-width: 820px){
    .tbl2 thead{display:none}
    .tbl2, .tbl2 tbody, .tbl2 tr, .tbl2 td{display:block;width:100%}
    .tbl2 tbody tr{border-bottom:1px solid rgba(15,23,42,.10);padding:10px 10px 12px}
    .tbl2 tbody td{border-bottom:0;padding:6px 8px}
    .rowgrid{
      display:grid;grid-template-columns:1fr;gap:6px;
      background:rgba(255,255,255,.85);
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:10px;
    }
    .kv{display:flex;justify-content:space-between;gap:12px;font-size:13px;color:var(--muted,#64748b)}
    .kv b{color:inherit;font-weight:900}
    .actions{justify-content:flex-start;margin-top:8px}
  }

  /* ===== Dark mode (base html[data-theme="dark"]) ===== */
  html[data-theme="dark"] .search,
  html[data-theme="dark"] .chip,
  html[data-theme="dark"] .tblwrap{
    background:rgba(15,23,42,.55);
    border-color: rgba(148,163,184,.18);
  }
  html[data-theme="dark"] .tbl2 thead th{
    background:rgba(15,23,42,.65);
    border-bottom-color: rgba(148,163,184,.16);
    color: rgba(226,232,240,.75);
  }
  html[data-theme="dark"] .tbl2 tbody td{border-bottom-color: rgba(148,163,184,.14)}
  html[data-theme="dark"] .tbl2 tbody tr:hover{background:rgba(99,102,241,.10)}
  html[data-theme="dark"] .btn-soft,
  html[data-theme="dark"] .pager .pbtn,
  html[data-theme="dark"] .pager .pnum{
    background:rgba(15,23,42,.75);
    border-color: rgba(148,163,184,.18);
    color: rgba(226,232,240,.92);
  }
  html[data-theme="dark"] .pager{
    background:rgba(15,23,42,.45);
    border-top-color: rgba(148,163,184,.16);
  }
</style>

<div class="card">
  <div class="pagehead">
    <div>
      <h2 data-i18n="t1_reports_title">Hisobot №1 </h2>
      <div class="subtext" data-i18n="t1_reports_sub">
        Sana bo‘yicha hisobotlar ro‘yxati. Qidiruv orqali tez topishingiz mumkin.
      </div>
    </div>

    
    <a class="btn-cta" href="/station/table-1/view/{{ today }}/" data-i18n="create_report">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Hisobot yaratish
    </a>
  </div>

  <div class="controls">
    <div class="search">
      <span class="ico">⌕</span>
      <input id="q" type="text"
             placeholder="Sana / yil / vaqt bo‘yicha qidirish…"
             data-i18n-placeholder="search_placeholder">
    </div>

    <div class="chip">
      <span data-i18n="shown">Ko‘rsatilmoqda</span>:
      <b id="shownCount">0</b>
    </div>

    <div class="chip">
      <span data-i18n="total">Jami</span>:
      <b id="totalCount">0</b>
    </div>
  </div>

  <div class="tblwrap">
    <table class="tbl2" id="t1table">
      <thead>
        <tr>
          <th style="width:180px" data-i18n="col_date">Дата</th>
          <th style="width:90px" data-i18n="col_year">Год</th>
          <th style="width:190px" data-i18n="col_sent">Отправлено</th>
          <th style="width:360px;text-align:right" data-i18n="col_actions">Действия</th>
        </tr>
      </thead>

      <tbody id="t1body">
        {% for r in rows %}
        <tr class="t1row"
            data-search="{{ r.date|date:'d.m.Y' }} {{ r.date|date:'Y-m-d' }} {{ r.year }} {% if r.submitted_at %}{{ r.submitted_at|date:'d.m.Y H:i' }}{% endif %}">
          <td class="dateCell"><b>{{ r.date|date:"d.m.Y" }}</b></td>
          <td>{{ r.year }}</td>
          <td class="mutedCell">
            {% if r.submitted_at %}{{ r.submitted_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}
          </td>
          <td>
            <div class="actions">
              <a class="btn-soft" href="/station/table-1/view/{{ r.date|date:'Y-m-d' }}/" data-i18n="view">Просмотр</a>
              <a class="btn-soft" href="/station/table-1/edit/{{ r.date|date:'Y-m-d' }}/" data-i18n="edit">Редактировать</a>

              <form method="post"
                    action="/station/table-1/delete/{{ r.date|date:'Y-m-d' }}/"
                    style="display:inline;"
                    onsubmit="return confirm(window.__t?.confirm_delete || 'Удалить отчёт?');">
                {% csrf_token %}
                <button class="btn-danger" type="submit" data-i18n="delete">Удалить</button>
              </form>
            </div>

            <!-- Mobile -->
            <div class="rowgrid" style="display:none">
              <div class="kv"><span data-i18n="col_date">Дата</span><b>{{ r.date|date:"d.m.Y" }}</b></div>
              <div class="kv"><span data-i18n="col_year">Год</span><b>{{ r.year }}</b></div>
              <div class="kv"><span data-i18n="col_sent">Отправлено</span>
                <b>{% if r.submitted_at %}{{ r.submitted_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}</b>
              </div>
              <div class="actions">
                <a class="btn-soft" href="/station/table-1/view/{{ r.date|date:'Y-m-d' }}/" data-i18n="view">Просмотр</a>
                <a class="btn-soft" href="/station/table-1/edit/{{ r.date|date:'Y-m-d' }}/" data-i18n="edit">Редактировать</a>
                <form method="post"
                      action="/station/table-1/delete/{{ r.date|date:'Y-m-d' }}/"
                      style="display:inline;"
                      onsubmit="return confirm(window.__t?.confirm_delete || 'Удалить отчёт?');">
                  {% csrf_token %}
                  <button class="btn-danger" type="submit" data-i18n="delete">Удалить</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="padding:16px;color:var(--muted,#64748b)">
            <span data-i18n="empty">Пока нет отчётов. Нажми “Создать отчёт”.</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="pager" id="pager" style="display:none;">
      <div class="info" id="pagerInfo">—</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button class="pbtn" id="prevBtn" type="button">‹</button>
        <div class="pnums" id="pnums"></div>
        <button class="pbtn" id="nextBtn" type="button">›</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== Responsive: show mobile card blocks =====
  function syncMobileRows(){
    const isMobile = window.matchMedia("(max-width: 820px)").matches;
    document.querySelectorAll(".t1row").forEach(tr=>{
      const rowgrid = tr.querySelector(".rowgrid");
      if(rowgrid) rowgrid.style.display = isMobile ? "grid" : "none";
    });
  }
  window.addEventListener("resize", syncMobileRows);
  syncMobileRows();

  // ===== Frontend filter + pager =====
  const PAGE_SIZE = 10;
  const q = document.getElementById("q");
  const rows = Array.from(document.querySelectorAll(".t1row"));
  const pager = document.getElementById("pager");
  const pnums = document.getElementById("pnums");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pagerInfo = document.getElementById("pagerInfo");
  const shownCount = document.getElementById("shownCount");
  const totalCount = document.getElementById("totalCount");

  let filtered = rows.slice();
  let page = 1;

  function paginate(){
    const total = filtered.length;
    totalCount.textContent = String(rows.length);

    const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    page = Math.min(page, pages);

    const start = (page - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;

    rows.forEach(r => r.style.display = "none");
    filtered.slice(start, end).forEach(r => r.style.display = "");

    shownCount.textContent = String(filtered.slice(start, end).length);

    pager.style.display = (rows.length > 0 && total > PAGE_SIZE) ? "" : "none";
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= pages;

    pagerInfo.textContent = `${start + 1}–${Math.min(end, total)} / ${total}`;

    pnums.innerHTML = "";
    const maxBtns = 7;
    let from = Math.max(1, page - 3);
    let to = Math.min(pages, from + (maxBtns - 1));
    from = Math.max(1, to - (maxBtns - 1));

    for(let i=from;i<=to;i++){
      const b = document.createElement("button");
      b.type="button";
      b.className = "pnum" + (i===page ? " active" : "");
      b.textContent = i;
      b.addEventListener("click", ()=>{page=i; paginate();});
      pnums.appendChild(b);
    }
  }

  function applyFilter(){
    const term = (q.value || "").trim().toLowerCase();
    filtered = !term ? rows.slice() : rows.filter(r => (r.dataset.search || "").toLowerCase().includes(term));
    page = 1;
    paginate();
  }

  q && q.addEventListener("input", applyFilter);
  prevBtn && prevBtn.addEventListener("click", ()=>{page=Math.max(1, page-1); paginate();});
  nextBtn && nextBtn.addEventListener("click", ()=>{page=page+1; paginate();});

  paginate();
})();
</script>
{% endblock %}
